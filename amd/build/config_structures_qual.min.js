define(["jquery","jqueryui","block_gradetracker/bcpopup"],function(a,b,c){var d={};d.ruleOperator=".",d.ruleEvents=[],d.ruleComparisons=[],d.numCustomFormFields=0,d.numRuleSets=0,d.numRules=[],d.numRuleSteps=[],d.init=function(){d.numRuleSets=a(".gt_rule_set_row").length;var b=1;a(".gt_rule_set_row").each(function(){d.numRuleSteps[b]=[],d.numRules[b]=a(".gt_rule_row_"+b).length;var c=1;a(".gt_rule_row_"+b).each(function(){d.numRuleSteps[b][c]=a(".gt_rule_step_"+b+"_"+c).length;var e=1;a(".gt_rule_step_"+b+"_"+c).each(function(){a(this).removeClass("gt_hidden").addClass("gt_rule_step_"+b+"_"+c),a(this).find("div.gt_rule_step_condition").removeClass("gt_hidden").addClass("gt_rule_step_condition_"+b+"_"+c+"_"+e),a(this).find("div.gt_rule_step_action").removeClass("gt_hidden").addClass("gt_rule_step_action_"+b+"_"+c+"_"+e),e++}),c++}),b++}),d.bindings()},d.bindings=function(){d.numCustomFormFields=a(".gt_custom_form_field_row").length,d.numRuleSets=a(".gt_rule_set_row").length,a(".gt_level_box, .gt_feature_box").unbind("click"),a(".gt_level_box, .gt_feature_box").bind("click",function(){var b=a(this).children('input[type="checkbox"]');b.prop("checked",!b.prop("checked")),b.prop("checked")===!0?(a(this).addClass("ticked"),a(this).children("img.gt_ticked").css("display","inline-block")):(a(this).removeClass("ticked"),a(this).children("img.gt_ticked").css("display","none"))}),a(".gt_level_box input").click(function(a){a.stopPropagation()}),a("#gt_add_structure_form_field").unbind("click"),a("#gt_add_structure_form_field").bind("click",function(b){d.numCustomFormFields++;var c="";c+="<tr id='gt_custom_form_field_row_"+d.numCustomFormFields+"' class='gt_custom_form_field_row'>",c+="<td><input type='text' name='custom_form_fields_names["+d.numCustomFormFields+"]' /></td>",c+="<td><select name='custom_form_fields_forms["+d.numCustomFormFields+"]'><option></option><option value='qualification'>"+M.util.get_string("qualification","block_gradetracker")+"</option><option value='unit'>"+M.util.get_string("unit","block_gradetracker")+"</option></select></td>",c+="<td><select class='gt_toggle_structure_form_field_type' num='"+d.numCustomFormFields+"' name='custom_form_fields_types["+d.numCustomFormFields+"]'><option></option><option value='TEXT'>"+M.util.get_string("element:text","block_gradetracker")+"</option><option value='NUMBER'>"+M.util.get_string("element:number","block_gradetracker")+"</option><option value='TEXTBOX'>"+M.util.get_string("element:textbox","block_gradetracker")+"</option><option value='SELECT'>"+M.util.get_string("element:select","block_gradetracker")+"</option><option value='CHECKBOX'>"+M.util.get_string("element:checkbox","block_gradetracker")+"</option></select></td>",c+="<td><input type='text' style='display:none;' id='custom_form_fields_options_"+d.numCustomFormFields+"' name='custom_form_fields_options["+d.numCustomFormFields+"]' placeholder='option1,option2,option3' /></td>",c+="<td><input type='checkbox' name='custom_form_fields_req["+d.numCustomFormFields+"]' value='1' /></td>",c+="<td><a href='#' class='gt_remove' remove='#gt_custom_form_field_row_"+d.numCustomFormFields+"'><img src='"+M.cfg.wwwroot+"/blocks/gradetracker/pix/remove.png' alt='remove' /></a></td>",c+="</tr>",a("#gt_custom_form_fields").append(c),d.bindings(),b.preventDefault()}),a(".gt_toggle_structure_form_field_type").unbind("click"),a(".gt_toggle_structure_form_field_type").bind("click",function(){var b=a(this).val(),c=a(this).attr("num");"SELECT"==b?a("#custom_form_fields_options_"+c).show():a("#custom_form_fields_options_"+c).hide()}),a("#gt_add_structure_rule_set").unbind("click"),a("#gt_add_structure_rule_set").bind("click",function(b){d.numRuleSets++;var c=d.numRuleSets;d.numRules[c]=0,d.numRuleSteps[c]=[];var e="";e+="<tr id='gt_rule_set_row_"+c+"' class='gt_rule_set_row'>",e+="<td></td>",e+="<td><input type='text' id='rule_set_name_"+c+"' name='rule_sets["+c+"][name]' value='' /></td>",e+="<td><a href='#' class='gt_structure_open_rules' ruleSetNum='"+c+"'>"+M.util.get_string("openrules","block_gradetracker")+" <img src='"+M.cfg.wwwroot+"/blocks/gradetracker/pix/open.png' alt='open' /></a></td>",e+="<td><input type='radio' name='rule_set_default' value='"+c+"' /></td>",e+="<td><input type='checkbox' name='rule_sets["+c+"][enabled]' value='1' checked /></td>",e+="<td><a href='#' class='gt_remove_structure_rule_set' ruleSetNum='"+c+"'><img src='"+M.cfg.wwwroot+"/blocks/gradetracker/pix/remove.png' alt='delete' /></a></td>",e+="</tr>",a("#gt_structure_rule_sets").append(e),d.bindings(),b.preventDefault()}),a(".gt_remove_structure_rule_set").unbind("click"),a(".gt_remove_structure_rule_set").bind("click",function(b){var c=a(this).attr("ruleSetNum");a("#gt_rule_set_row_"+c).remove(),a("#gt_popup_rules_"+c).length>0&&a("#gt_popup_rules_"+c).bcPopUp("destroy"),b.preventDefault()}),a(".gt_structure_open_rules").unbind("click"),a(".gt_structure_open_rules").bind("click",function(b){var c=a(this).attr("ruleSetNum");if(0==a("#gt_popup_rules_"+c).length)GT.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_rule_set_template",params:{ruleSetNum:c}},function(b){a("form#gt_qual_structure_form").append(b);var e=a("#gt_popup_rules_"+c).html(),f=GT.html(a("#rule_set_name_"+c).val());d.openRulesPopup(c,f,e),d.bindings()});else{var e=a("#gt_popup_rules_"+c).html(),f=GT.html(a("#rule_set_name_"+c).val());d.openRulesPopup(c,f,e),d.bindings()}b.preventDefault()}),a(".gt_add_rule").unbind("click"),a(".gt_add_rule").bind("click",function(b){var c=a(this).attr("ruleSetNum");d.numRules[c]++;var e=d.numRules[c];d.numRuleSteps[c][e]=0;var f={ruleSetNum:c,ruleNum:e};GT.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_rule_form",params:f},function(b){var f='<tr id="gt_rule_row_'+c+"_"+e+'" class="gt_rule_row_'+c+'"><td><a href="#" id="gt_rule_name_link_'+c+"_"+e+'" class="gt_edit_rule" ruleSetNum="'+c+'" ruleNum="'+e+'">'+M.util.get_string("newrule","block_gradetracker")+'</a></td><td><span id="gt_rule_event_span_'+c+"_"+e+'"></span></td><td><span id="gt_rule_steps_span_'+c+"_"+e+'">0</span></td><td><div class="gt_fancy_checkbox"><input id="chkbox_'+c+"_"+e+'" type="checkbox" name="rule_sets['+c+"][rules]["+e+'][enabled]" value="1" checked /><label for="chkbox_'+c+"_"+e+'"></label></div></td><td><a href="#" class="gt_remove" remove="#gt_rule_row_'+c+"_"+e+", #gt_rule_content_"+c+"_"+e+'"><img src="'+M.cfg.wwwroot+'/blocks/gradetracker/pix/remove.png" alt="delete" /></a></td></tr>';a("#gt_popup_rules_table_"+c+" table").append(f),a("#gt_popup_rules_divs_"+c).append(b),d.bindings(),a("#gt_rule_name_link_"+c+"_"+e).click()}),b.preventDefault()}),a(".gt_edit_rule").unbind("click"),a(".gt_edit_rule").bind("click",function(b){var c=a(this).attr("ruleSetNum"),d=a(this).attr("ruleNum");a(".gt_rule_content").hide(),a("#gt_rule_content_"+c+"_"+d).fadeIn("slow"),a("input.gt_rule_name").off("keyup"),a("input.gt_rule_name").on("keyup",function(){var b=a(this).val().trim();""==b&&(b="-"),a("a#gt_rule_name_link_"+c+"_"+d).text(b)}),a("input.gt_rule_event").off("change"),a("input.gt_rule_event").on("change",function(){a("span#gt_rule_event_span_"+c+"_"+d).text(a(this).val())}),b.preventDefault()}),a(".gt_add_rule_step").unbind("click"),a(".gt_add_rule_step").bind("click",function(b){var c=a(this).attr("ruleSetNum"),e=a(this).attr("ruleNum");if(a(".gt_rule_on_event_"+c+"_"+e).is(":checked")===!1){var f=a("<div>"+M.util.get_string("errors:rule:oneventmissing","block_gradetracker")+"</div>").dialog({autoOpen:!1,width:400,dialogClass:"gt_jq_dialog",buttons:[{text:"Ok",click:function(){a(this).dialog("close")}}],show:{effect:"slideDown",duration:300},hide:{effect:"slideUp",duration:300}});return f.data("uiDialog")._title=function(a){a.html(this.options.title)},f.dialog("option","title",'<span class="ui-icon ui-icon-alert"></span>'),f.dialog("open"),!1}d.numRuleSteps[c][e]++;var g=d.numRuleSteps[c][e],h=a(".gt_rule_step_"+c+"_"+e+":not(#gt_rule_step_template)").length,i=h+1,j=a("#gt_rule_step_template").clone();a(j).html(function(a,b){return b.replace(/\[RS\]/g,c).replace(/\[R\]/g,e).replace(/\[S\]/g,g)}),a(j).attr("id","gt_rule_step_"+c+"_"+e+"_"+g),a(j).attr("stepNum",i),a(j).addClass("gt_rule_step_"+c+"_"+e),a(j).removeClass("gt_hidden").removeClass("gt_rule_step_[RS]_[R]"),a(a(j).find(".gt_step_num")[0]).text(i),a("#gt_rule_steps_"+c+"_"+e).append(j),d.bindings(),d.updateStepNumbers(c,e),b.preventDefault()}),a(".gt_remove_rule_step").unbind("click"),a(".gt_remove_rule_step").bind("click",function(b){var c=a(this).attr("ruleSetNum"),e=a(this).attr("ruleNum"),f=a(this).attr("ruleStepNum");a("#gt_rule_step_"+c+"_"+e+"_"+f).remove(),d.updateStepNumbers(c,e),b.preventDefault()}),a(".gt_add_rule_step_condition").unbind("click"),a(".gt_add_rule_step_condition").bind("click",function(b){var c=a(this).attr("ruleSetNum"),e=a(this).attr("ruleNum"),f=a(this).attr("ruleStepNum"),g=a("#gt_rule_step_condition_template").clone();a(g).html(function(a,b){return b.replace(/\[RS\]/g,c).replace(/\[R\]/g,e).replace(/\[S\]/g,f)}),a(g).attr("id",""),a(g).addClass("gt_rule_step_condition_"+c+"_"+e+"_"+f),a(g).removeClass("gt_hidden"),a(a(this).parents("div.gt_rule_step_content").find("div.gt_step_conditions")[0]).append(g),d.bindings(),b.preventDefault()}),a(".gt_add_rule_step_action").unbind("click"),a(".gt_add_rule_step_action").bind("click",function(b){var c=a(this).attr("ruleSetNum"),e=a(this).attr("ruleNum"),f=a(this).attr("ruleStepNum"),g=a("#gt_rule_step_action_template").clone();a(g).html(function(a,b){return b.replace(/\[RS\]/g,c).replace(/\[R\]/g,e).replace(/\[S\]/g,f)}),a(g).attr("id",""),a(g).addClass("gt_rule_step_action_"+c+"_"+e+"_"+f),a(g).removeClass("gt_hidden"),a(a(this).parents("div.gt_rule_step_content").find("div.gt_step_actions")[0]).append(g),d.bindings(),b.preventDefault()}),a(".gt_remove_step_action, .gt_remove_rule_condition").unbind("click"),a(".gt_remove_step_action, .gt_remove_rule_condition").bind("click",function(b){a(this).parent().remove(),b.preventDefault()}),a(".gt_rule_step_condition_comparison").unbind("change"),a(".gt_rule_step_condition_comparison").bind("change",function(){var b=a(this).val();"is_met"===b||"is_not_met"===b?(a(this).parent().siblings(".gt_rule_condition_value_compare").addClass("gt_disabled"),a(this).parent().siblings(".gt_rule_condition_value_compare input").val("")):a(this).parent().siblings(".gt_rule_condition_value_compare").removeClass("gt_disabled")}),a(".gt_open_rule_fx").unbind("click"),a(".gt_open_rule_fx").bind("click",function(){var b=a(this).attr("type"),c=a(this);a(document).bcPopUp({title:M.util.get_string("function","block_gradetracker"),urlType:"ajax",url:M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php?action=get_rule_fx_panel",allowMultiple:!0,overrideWidth:"75%",buttons:{Confirm:function(){var b="",d=a("#gt_fx_text_input"),e=a("#gt_fx_func");if(d.length>0&&d.prop("disabled")!==!0){var f=d.val().trim();b='"'+f+'"'}else if(e.prop("disabled")!==!0){var f=e.val().trim();b=f}a(a(c).siblings("input")[0]).val(b),a("#gt_rule_fx").parents(".bc-modal").bcPopUp("close")}},afterLoad:function(){"action"==b&&(GT.toggle_disabled(".gt_fx_func","#gt_fx_text_input"),a("#gt_fx_text_input").parent().remove());var e=a(a(c).siblings("input")[0]).val();e.startsWith('"')||e.startsWith("'")?(e=e.substr(1,e.length-2),a("#gt_fx_text_input").val(e),GT.toggle_disabled("#gt_fx_text_input",".gt_fx_func")):""!=e&&(a("#gt_fx_func").val(e),GT.toggle_disabled(".gt_fx_func","#gt_fx_text_input")),d.bindings()}})}),a(".gt_add_rule_fx_element").unbind("click"),a(".gt_add_rule_fx_element").bind("click",function(){if("disabled"!=a(this).attr("disabled")){var b=a(this).attr("elType"),c=a(this).attr("fromType"),e=a(this).attr("fromVal"),f={type:b,fromType:c,fromVal:e};a("#gt_fx_loading").show(),GT.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_rule_fx_element_options",params:f},function(c){var e=a.parseJSON(c),f="<span>";if("filter"===b)f+='<select class="gt_fx_func" gttype="filter" filter="conjunction">',f+='<option value=""></option>',a.each(e.conjunctions,function(a,b){f+=' <option value="'+b+'">'+b+"</option>"}),f+="</select>",f+='<select class="gt_fx_func" gttype="filter" filter="field">',f+='<option value=""></option>',a.each(e.fields,function(a,b){f+=' <option value="'+b+'">'+b+"</option>"}),f+="</select>",f+='<input type="text" placeholder="v1,v2,v3..." class="gt_fx_func" gttype="filter" filter="value" />';else if("input"===b)f+='<input type="text" placeholder="value" class="gt_fx_func" gttype="input" />';else{var g=a('.gt_rule_fx_element_option[type="'+b+'"]').length,h=b+"_"+g;f+='<select id="'+h+'" class="gt_rule_fx_element_option gt_fx_func" gttype="'+b+'">',f+='<option value=""></option>',a.each(e,function(a,b){f+=void 0!==b.name?'<option value="'+b.name+'" return="'+b["return"]+'" object="'+b.object+'" longName="'+b.longName+'">'+b.name+"</option>":'<option value="'+b+'">'+b+"</option>"}),f+="</select>"}f+="</span>",a("#gt_fx_options").append(f),a(this).remove(),"method"===b&&a("#gt_rule_fx_link_filter").remove(),a("#gt_fx_loading").hide(),d.bindings()})}}),a(".gt_rule_fx_element_option").off("change"),a(".gt_rule_fx_element_option").on("change",function(){a("#gt_fx_loading").show();var b=a(this).attr("id"),c=a(this).attr("gttype"),e=a(this).val(),f=a(this).find(":selected"),g=a(f).attr("return"),h=a(f).attr("object"),i=a(f).attr("longName");a(this).parent().nextAll().each(function(){a('#gt_fx_links a[dependenton="'+a(this).attr("id")+'"]').remove(),a(this).remove()});var j="";if(a(".gt_rule_fx_element_option").each(function(){j+=a(this).attr("type")+"["+a(this).val()+"]."}),j=j.substring(0,j.length-1),""==e)return a('#gt_fx_links a[dependenton="'+b+'"]').remove(),a("#gt_fx_loading").hide(),!0;var k={type:c,value:e,returnType:g,returnValue:h,objStr:j,longName:i};GT.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_rule_fx_links",params:k},function(f){var g=a.parseJSON(f);a("#gt_fx_links").html(""),a.each(g,function(d,f){var g=void 0!==i?i:e;a("#gt_fx_links").append("<a href='#' id='gt_rule_fx_link_"+f+"' class='gt_fx_func gt_add_rule_fx_element' dependentOn='"+b+"' elType='"+f+"' fromType='"+c+"' fromVal='"+g+"'>"+M.util.get_string("add"+f,"block_gradetracker")+"</a>")}),a("#gt_fx_loading").hide(),d.bindings()}),d.updateFX()}),a("select.gt_fx_func").on("change",function(){d.updateFX()}),a("input.gt_fx_func").off("keyup"),a("input.gt_fx_func").on("keyup",function(){d.updateFX()}),GT.bind()},d.openRulesPopup=function(b,c,d){a("#gt_popup_rules_"+b).bcPopUp({title:M.util.get_string("rules","block_gradetracker")+" - "+c,content:d,allowMultiple:!0,overrideWidth:"90%",appendTo:"form#gt_qual_structure_form"})},d.updateStepNumbers=function(b,c){var d=1,e=a(".gt_rule_step_"+b+"_"+c+":not(#gt_rule_step_template)");a(e).each(function(){a(this).attr("id","gt_rule_step_"+b+"_"+c+"_"+d),a(this).attr("stepNum",d),a(a(this).find(".gt_step_num")[0]).text(d),a(this).find(":input").each(function(){var b=a(this).attr("name").replace(/\[steps\]\[(\d+)\]/,"[steps]["+d+"]");a(this).attr("name",b)}),d++}),a("#gt_rule_steps_span_"+b+"_"+c).text(d-1)},d.updateFX=function(){a("#gt_fx_func").val(d.convertElementsToFX())},d.convertElementsToFX=function(){var b="",c="";return a("#gt_fx_options :input").each(function(d,e){var f=a(e).val(),g=a(e).attr("gttype");if(f=f.replace(/['"]+/g,""),f=f.trim(),""!==f)if("object"==g)b+=f;else if("method"==g)b=b.replace(/\(x\)/g,"()"),b+="."+f+"(x)";else if("filter"==g){var h=a(e).attr("filter");if("conjunction"==h)c="",c+="'"+f+"'";else if("field"==h)c+=",'"+f+"'";else if("value"==h){var i=f.split(",");i=i.map(function(a){return"'"+a+"'"}),f=i.join(","),c+=","+f,b=b.replace("(x)","("+c+")")}}else if("input"==g){var j=b.lastIndexOf("(x)");b=b.slice(0,j)+b.slice(j).replace("(x)","('"+f+"')")}}),b=b.replace(/\(x\)/g,"()")};var e={};return e.log=function(a){console.log("[GT] "+(new Date).toTimeString().split(" ")[0]+": "+a)},e.init=function(){d.init(),e.log("Loaded config_structures_qual.js")},e});