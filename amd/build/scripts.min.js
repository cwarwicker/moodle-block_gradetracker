define(["jquery","jqueryui","block_gradetracker/bcpopup","block_gradetracker/bcnotify","block_gradetracker/freezetable"],function(a,b,c,d,e){var f={};f.keyMap={16:!1,17:!1,191:!1},f.isDebugging=0,f.init=function(){var b=a("#gt_debugging_enabled").val();f.isDebugging=b,f.bind()},f.bind=function(){a(".gt_toggle").off("click"),a(".gt_toggle").on("click",function(b){var c=a(this).attr("toggle");void 0!==c&&a(c).toggle(),b.preventDefault()}),a(".gt_show").off("click"),a(".gt_show").on("click",function(b){var c=a(this).attr("show");void 0!==c&&a(c).show(),b.preventDefault()}),a(".gt_hide").off("click"),a(".gt_hide").on("click",function(b){var c=a(this).attr("hide");void 0!==c&&a(c).hide(),b.preventDefault()}),a(".gt_show_hide").off("click"),a(".gt_show_hide").on("click",function(b){var c=a(this).attr("show"),d=a(this).attr("hide");void 0!==c&&a(c).show(),void 0!==d&&a(d).hide(),b.preventDefault()}),a(".gt_remove").unbind("click"),a(".gt_remove").bind("click",function(b){var c=a(this).attr("remove");"parent-row"===c&&(c=a(a(this).parents("tr")[0])),void 0!==c&&a(c).remove(),b.preventDefault()}),a(".gt_goto").unbind("click"),a(".gt_goto").bind("click",function(b){var c=a(this).attr("url");window.location=c,b.preventDefault()}),a(".gt_popup_url").off("click"),a(".gt_popup_url").on("click",function(b){var c=a(this).attr("title"),d=a(this).attr("url");f.open_url(c,d),b.preventDefault()}),a(".gt_refresh_url_time").off("click"),a(".gt_refresh_url_time").on("click",function(a){f.refresh_url_time(this)}),a(".gt_dropdown_toggle").unbind("click"),a(".gt_dropdown_toggle").bind("click",function(b){a(this).siblings("ul.gt_dropdown_menu").toggle(),b.preventDefault()}),a("input.gt_toggle_select_all").unbind("change"),a("input.gt_toggle_select_all").bind("change",function(){var b=a(this).prop("checked"),c=a(this).attr("useID"),d=a(this).attr("useClass");void 0!==c?a("#"+c+" option:enabled").prop("selected",b):void 0!==d&&a("."+d+" option:enabled").prop("selected",b)}),a("input.gt_toggle_check_all").unbind("change"),a("input.gt_toggle_check_all").bind("change",function(){var b=a(this).prop("checked"),c=a(this).attr("useClass");void 0!==c&&a("."+c).prop("checked",b)}),a("a.gt_toggle_check_all").unbind("click"),a("a.gt_toggle_check_all").bind("click",function(b){var c=a(this).prop("checked"),d=a(this).attr("useClass");void 0===c&&(c=a(a("."+d)[0]).val()),a(this).prop("checked",!c),void 0!==d&&a("."+d).prop("checked",c),b.preventDefault()}),a(".gt_freeze_table_checkbox").off("click"),a(".gt_freeze_table_checkbox").on("click",function(){var b=a(this).is(":checked"),c=a(this).attr("class").replace(/\s/g,".");a("."+c).prop("checked",b)}),a("#chosen_quals").unbind("change"),a("#chosen_quals").bind("change",function(){var b=a(this).val(),c=null!==b?b.length:0;1==c?(a("#gt_chosen_quals_edit_qual_btn").removeAttr("disabled"),a("#gt_chosen_quals_edit_qual_btn").attr("href","config.php?view=quals&section=edit&id="+b)):(a("#gt_chosen_quals_edit_qual_btn").attr("disabled",!0),a("#gt_chosen_quals_edit_qual_btn").removeAttr("href"))}),a(".gt_date").datepicker({dateFormat:"dd-mm-yy",showButtonPanel:!0}),a(".gt_help_tooltip").off("click"),a(".gt_help_tooltip").on("click",function(){var b=a(this).attr("content");a("<div>"+b+"</div>").dialog({minHeight:100})}),a.fn.optVisible=function(a){return a?this.filter("span > option").unwrap():this.filter(":not(span > option)").wrap("<span>").parent().hide(),this},a.fn.optToggle=function(){a(this).parent("span").length>0?a(this).optVisible(!0):a(this).optVisible(!1)},a(".gt_qual_picker_remove").unbind("click"),a(".gt_qual_picker_remove").bind("click",function(a){f.qual_picker.remove(),a.preventDefault()}),a(".gt_qual_picker_filter").unbind("click"),a(".gt_qual_picker_filter").bind("click",function(a){f.qual_picker.filter(),a.preventDefault()}),a(".gt_qual_picker_add").unbind("click"),a(".gt_qual_picker_add").bind("click",function(a){f.qual_picker.add(),a.preventDefault()}),a("#gt_filter_qual_name").unbind("keypress"),a("#gt_filter_qual_name").bind("keypress",function(a){13===a.keyCode&&(f.qual_picker.filter(),a.preventDefault())}),a(".gt_mod_hook_units").unbind("change"),a(".gt_mod_hook_units").bind("change",function(){var b=a("#gt_cmid").val(),c=a("#gt_cid").val(),d=a(this).attr("qualID"),e=a(this).val(),g={qualID:d,unitID:e,cmID:b,courseID:c};a("#gt_mod_hook_loader_"+d).show(),f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_mod_hook_unit",params:g},function(b){var c=a.parseJSON(b),g="";g+="<div id='gt_hooked_unit_"+d+"_"+e+"' class='gt_hooked_unit'>",g+=""+c.unit+" <a href='#' class='gt_mod_hook_delete_unit' qualID='"+d+"' unitID='"+e+"'><img src='"+M.util.image_url("t/delete")+"' /></a><br>",g+="<table class='gt_c gt_hook_unit_criteria'>",g+="<tr>",a.each(c.criteria,function(a,b){g+="<th>"+b.name+"</th>"}),g+="</tr>",g+="<tr>",a.each(c.criteria,function(b,f){g+="<td>",c.parts?(g+="<select name='gt_criteria["+d+"]["+e+"]["+f.id+"]'>",g+="<option value='0'></option>",a.each(c.parts,function(a,b){g+="<option value='"+b.id+"'>"+b.name+"</option>"}),g+="</select>"):g+="<input type='checkbox' name='gt_criteria["+d+"]["+e+"]["+f.id+"]' />",g+="</td>"}),g+="</tr>",g+="</table>",g+="</div>",a("#gt_mod_hook_qual_units_"+d).append(g),a("#gt_mod_hook_loader_"+d).hide(),f.bind()}),a(this).prop("selectedIndex",0),a(this).children('option[value="'+e+'"]').prop("disabled",!0)}),a(".gt_mod_hook_delete_unit").unbind("click"),a(".gt_mod_hook_delete_unit").bind("click",function(b){var c=a(this).attr("qualID"),d=a(this).attr("unitID");a("#gt_hooked_unit_"+c+"_"+d).remove(),a("#gt_mod_hook_"+c+"_units_select").children('option[value="'+d+'"]').prop("disabled",!1),b.preventDefault()}),a(".gt_mod_hook_delete_activity").unbind("click"),a(".gt_mod_hook_delete_activity").bind("click",function(b){var c=a(this).attr("cmID");a("#gt_hooked_activity_"+c).remove(),a(".gt_mod_activity").children('option[value="'+c+'"]').prop("disabled",!1),b.preventDefault()}),a(".gt_mod_change_qual_units").unbind("change"),a(".gt_mod_change_qual_units").bind("change",function(b){a("#gt_mod_hook_activities").html(""),a("#gt_mod_change_qual_units_units").prop("selectedIndex",0);var c=a(this).val();a("option.AQU").hide(),a("option.Q_"+c).show()}),a("#gt_mod_change_qual_units_units").unbind("change"),a("#gt_mod_change_qual_units_units").bind("change",function(){var b=a("#gt_cid").val(),c=a(".gt_mod_change_qual_units").val(),d=a(this).val(),e={qualID:c,unitID:d,courseID:b};a("#gt_mod_hook_loader_activity").show(),a("#gt_mod_hook_activities").html(""),a(".gt_mod_activity").children("option").prop("disabled",!1),f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_mod_hook_unit_activities",params:e},function(b){var c=a.parseJSON(b),d="";a.each(c,function(b,c){d+="<div id='gt_hooked_activity_"+c.id+"' class='gt_hooked_unit'>",d+="<img src='"+c.icon+"' /> "+c.name+" <a href='#' class='gt_mod_hook_delete_activity' cmID='"+c.id+"'><img src='"+M.util.image_url("t/delete")+"' /></a><br>",d+="<table class='gt_c gt_hook_unit_criteria'>",d+="<tr>",a.each(c.criteria,function(a,b){d+="<th>"+b.name+"</th>"}),d+="</tr>",d+="<tr>",a.each(c.criteria,function(b,e){if(d+="<td>",c.parts)d+="<select name='gt_criteria["+c.id+"]["+e.id+"]'>",d+="<option value='0'></option>",a.each(c.parts,function(a,b){var f=void 0!==c.partsLinked[e.id]&&c.partsLinked[e.id]==b.id?"selected":"";d+="<option value='"+b.id+"' "+f+" >"+b.name+"</option>"}),d+="</select>";else{var f=c.linked.indexOf(e.id)>=0?"checked":"";d+="<input type='checkbox' name='gt_criteria["+c.id+"]["+e.id+"]' "+f+" />"}d+="</td>"}),d+="</tr>",d+="</table>",d+="</div>",a(".gt_mod_activity").children('option[value="'+c.id+'"]').prop("disabled",!0)}),a("#gt_mod_hook_activities").append(d),a("#gt_mod_hook_loader_activity").hide(),f.bind()}),a(".gt_mod_activity").prop("selectedIndex",0)}),a(".gt_mod_activity").unbind("change"),a(".gt_mod_activity").bind("change",function(){var b=a(this).val(),c=a(".gt_mod_change_qual_units").val(),d=a("#gt_mod_change_qual_units_units").val(),e=a("#gt_cid").val();if(""==c||""==d||""==e)return!1;var g={qualID:c,unitID:d,courseID:e,cmID:b};a("#gt_mod_hook_loader_activity").show(),f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_mod_hook_activity",params:g},function(c){var d=a.parseJSON(c),e="";e+="<div id='gt_hooked_activity_"+d.id+"' class='gt_hooked_unit'>",e+="<img src='"+d.icon+"' /> "+d.name+" <a href='#' class='gt_mod_hook_delete_activity' cmID='"+d.id+"'><img src='"+M.util.image_url("t/delete")+"' /></a><br>",e+="<table class='gt_c gt_hook_unit_criteria'>",e+="<tr>",a.each(d.criteria,function(a,b){e+="<th>"+b.name+"</th>"}),e+="</tr>",e+="<tr>",a.each(d.criteria,function(c,f){e+="<td>",d.parts?(e+="<select name='gt_criteria["+b+"]["+f.id+"]'>",e+="<option value='0'></option>",a.each(d.parts,function(a,b){e+="<option value='"+b.id+"'>"+b.name+"</option>"}),e+="</select>"):e+="<input type='checkbox' name='gt_criteria["+b+"]["+f.id+"]' />",e+="</td>"}),e+="</tr>",e+="</table>",e+="</div>",a("#gt_mod_hook_activities").append(e),a("#gt_mod_hook_loader_activity").hide(),f.bind()}),a(this).prop("selectedIndex",0),a(this).children('option[value="'+b+'"]').prop("disabled",!0)}),a(".gt_reporting_dropdown").unbind("click"),a(".gt_reporting_dropdown").bind("click",function(b){var c=a(this).attr("qualID"),d={qualid:c};0==a("#gt_table_row_"+c).length?(a("#report_icon_"+c).attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/ajax-loader.gif"),f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_qualification_report",params:d},function(b){a("#gt_row_"+c).after(b),a("#report_icon_"+c).attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/dropup.png"),a("#student_table_view_"+c).freezeTable(),f.bind()})):(a("#gt_table_row_"+c).remove(),a("#report_icon_"+c).attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/dropdown.png")),b.preventDefault()}),a(".gt_filter_qualification_report").unbind("change"),a(".gt_filter_qualification_report").bind("change",function(){var b=a(this).attr("qualID");a(".reporting_table_row_"+b).show(),"allmarked"==a("#student_filter_"+b+" select").val()?a(".reporting_table_row_"+b).each(function(){var b=a(this).attr("unitsawarded"),c=a(this).attr("totalunits");b!=c&&a(this).hide()}):"all"==a("#student_filter_"+b+" select").val()?a(".reporting_table_row_"+b).each(function(){a(this).show()}):"someoutstanding"==a("#student_filter_"+b+" select").val()?a(".reporting_table_row_"+b).each(function(){var b=a(this).attr("unitsawarded"),c=a(this).attr("totalunits");b>=c&&0!=c&&a(this).hide()}):"alloutstanding"==a("#student_filter_"+b+" select").val()&&a(".reporting_table_row_"+b).each(function(){var b=a(this).attr("unitsawarded");0!=b&&a(this).hide()})}),a(".gt_toggle_edit_grades").unbind("click"),a(".gt_toggle_edit_grades").bind("click",function(b){var c=a(this).attr("type"),d=a(this).attr("qualID");a(".stud_"+c+"_grade_view_"+d).toggle(),a(".stud_"+c+"_grade_edit_"+d).toggle(),b.preventDefault()}),a(".gt_calculate_grades").unbind("click"),a(".gt_calculate_grades").bind("click",function(b){var c=a(this).attr("type"),d=a(this).attr("qualID");if(a("#loading_"+d).show(),"target"==c)var e="get_refreshed_target_grades",g="stud_target_grade_view_"+d+"_",h="stud_target_grade_edit_"+d+"_",i="stud_weighted_target_grade_view_"+d+"_";else{if("aspirational"!=c)return a("#loading_"+d).hide(),!1;var e="get_refreshed_aspirational_grades",g="stud_aspirational_grade_view_"+d+"_",h="stud_aspirational_grade_edit_"+d+"_"}var j={qualID:d};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:e,params:j},function(b){var e=a.parseJSON(b);a.each(e,function(b,d){var e="#"+g+b,f="#"+h+b,j="#"+i+b;if("target"==c){var k=d.target;if(1==k.result?(a(e).text(k.grade),0!==k.error&&""!==k.error&&void 0!==k.error&&a(e).append('<small style="color:red";><br>'+k.error+"</small>"),a(f+" select").val(k.gradeID),a(a(e).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(e).html('<span style="color:red;">'+k.error+"</span>"),a(f+" select").val(""),a(a(e).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3)),void 0!==d.weighted){var k=d.weighted;1==k.result?(a(j).text(k.grade),0!==k.error&&""!==k.error&&void 0!==k.error&&a(j).append('<small style="color:red";><br>'+k.error+"</small>"),a(a(j).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(j).html('<span style="color:red;">'+k.error+"</span>"),a(a(j).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3))}}else 1==d.result?(a(e).text(d.grade),0!==d.error&&""!==d.error&&void 0!==d.error&&a(e).append('<small style="color:red";><br>'+d.error+"</small>"),a(f+" select").val(d.gradeID),a(a(e).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(e).html('<span style="color:red;">'+d.error+"</span>"),a(f+" select").val(""),a(a(e).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3))}),a("#student_table_view_"+d).freezeTable(),a("#loading_"+d).hide()}),b.preventDefault()}),a(".gt_refresh_predicted_grades").unbind("click"),a(".gt_refresh_predicted_grades").bind("click",function(b){var c=a(this).attr("qualID");a("#loading_"+c).show();var d={action:"get_refreshed_predicted_grades",params:{qualID:c}};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",d,function(b){b=a.parseJSON(b),a.each(b,function(b,d){if(a("#gt_qualAward_Q"+c+"_S"+b+" > div").length>0)var e="#gt_qualAward_Q"+c+"_S"+b+" > div";else var e="#gt_qualAward_Q"+c+"_S"+b;void 0!==d["final"]&&d["final"]!==M.util.get_string("na","block_gradetracker")?a(e).text(d["final"]+" (Final)").effect("highlight",{color:"#ccff66"},3e3):void 0!==d.average&&d.average!==M.util.get_string("na","block_gradetracker")?a(e).text(d.average+" (Average)").effect("highlight",{color:"#ccff66"},3e3):a(e).text(M.util.get_string("na","block_gradetracker")).effect("highlight",{color:"#ccff66"},3e3)}),a("#loading_"+c).hide()}),b.preventDefault()}),a(".gt_change_report_tab").unbind("click"),a(".gt_change_report_tab").bind("click",function(b){var c=a(this).attr("qualID"),d=a(this).attr("tab");"students"==d?a("#students_"+c).hasClass("selected")||(a("#units_"+c).attr("class",""),a("#students_"+c).attr("class","selected"),a("#student_filter_"+c).show(),a("#student_table_view_"+c).show(),a("#unit_table_view_"+c).hide(),a("#students_view_buttons").show()):"units"==d&&(a("#units_"+c).hasClass("selected")||(a("#students_"+c).attr("class",""),a("#units_"+c).attr("class","selected"),a("#student_filter_"+c).hide(),a("#student_table_view_"+c).hide(),a("#unit_table_view_"+c).show(),a("#students_view_buttons").hide())),b.preventDefault()}),a(".gt_update_user_grade").unbind("change"),a(".gt_update_user_grade").bind("change",function(){var b=a(a(this).parents("td")[0]),c=a(this).attr("sID"),d=a(this).attr("qID"),e=a(this).attr("type"),g=a(this).attr("txtView"),h=a(this).val(),i={sID:c,qID:d,type:e,awardID:h};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/update.php",{action:"update_user_grade",params:i},function(c){0===c.length?(a(b).effect("highlight",{color:"#f24c3d"},3e3),alert(M.util.get_string("couldnotupdate","block_gradetracker"))):(c=a.parseJSON(c),a(b).effect("highlight",{color:"#ccff66"},3e3),a(g).text(c.grade))})}),a("select#gt_choose_filter_all_qual").unbind("change"),a("select#gt_choose_filter_all_qual").bind("change",function(){a("select#gt_choose_filter_all_course").val("")}),a("select#gt_choose_filter_all_course").unbind("change"),a("select#gt_choose_filter_all_course").bind("change",function(){a("select#gt_choose_filter_all_qual").val("")}),a("select#gt_choose_filter_my_qual").unbind("change"),a("select#gt_choose_filter_my_qual").bind("change",function(){a("select#gt_choose_filter_my_course").val("")}),a("select#gt_choose_filter_my_course").unbind("change"),a("select#gt_choose_filter_my_course").bind("change",function(){a("select#gt_choose_filter_my_qual").val("")}),a(document).keydown(function(a){a.keyCode in f.keyMap&&(f.keyMap[a.keyCode]=!0)}).keyup(function(b){a.each(f.keyMap,function(a,b){f.keyMap[a]=!1})})},f.read_file=function(b,c){if(b.files&&b.files[0]){var d=new FileReader;d.onload=function(d){b.files[0].name.match(/\.(jpg|jpeg|png|gif)$/)?a(c).attr("src",d.target.result):a(c).attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/no_image.jpg")},d.readAsDataURL(b.files[0])}},f.notify=function(b,c,d){a.bcNotify({type:b,content:c,position:d})},f.refresh_url_time=function(b){a(b).attr("href",a(b).attr("href").replace(/t=\d+/,"t="+Date.now()))},f.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a},f.checkbox_toggle=function(b,c){var d=a(b).prop("checked");a("."+c).prop("checked",d)},f.show_section=function(b,c,d){a(d).parents("ul").find("a").removeClass("selected"),a("."+c).hide(),a("#"+b).slideDown(),a(d).addClass("selected")},f.centre=function(b){var c=a(b).width(),d=(a(window).width()-c)/2;a(b).css("left",d+"px")},f.toggle_import_grid_tables=function(b){a(".gt_import_grid_table").hide(),a("#gt_import_grid_table_"+b).show()},f.html=function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},f.open_url=function(b,c){a(document).bcPopUp({title:b,open:function(){a(".bc-modal-body").html('<img src="'+M.cfg.wwwroot+'/blocks/gradetracker/pix/ajax-loader.gif" />'),a(".bc-modal-body").load(c)},allowMultiple:!1})},f.ajax=function(b,c,d,e){e&&e(),a.ajax({type:"POST",url:b,data:c,error:function(a){f.ajax_error(a.responseText),g.log("Error: "+a)},success:function(a){return 0===a.length||a.indexOf("<!DOCTYPE")>=0?(alert("No data was returned by this request. Your Moodle session may have timed out, please refresh the page and see if you need to login again."),!1):void(d&&d(a))}})},f.ajaxProgress=function(b,c,d,e){var f=!1,g=a(d).attr("max"),h=a("#"+c.params.btn);a(d).val(0),a("#gt_progress_errors").remove();var i=a.ajax({xhr:function(){var b=new window.XMLHttpRequest;return b.addEventListener("progress",function(c){var e=a(d),j=b.responseText;if(j.length){if("{"!==j.charAt(0)||"}"!==j.charAt(j.length-1)){var k=a("#gt_progress_errors");return 0==k.length&&(a(d).before('<div id="gt_progress_errors" class="gt_alert_bad"></div>'),k=a("#gt_progress_errors")),k.html(j),k.show(),a("#gt_report_time_left").text(""),h.prop("disabled",!1),h.val(M.util.get_string("run","block_gradetracker")),i.abort(),!1}var l=j.match(/\{.*?\}/g),m=l.pop();if(m.length>0){var n=a.parseJSON(m);if(f===!1)f=n.time;else if(n.progress<100){var o=g-n.progress,p=o/n.progress,q=n.time-f,r=Math.round(q*p);r>0&&a("#gt_report_time_left").text(r+" "+M.util.get_string("sexleft","block_gradetracker"))}"pending"==n.result&&e.val(n.progress)}}},!1),b},url:b,type:"POST",data:c,dataType:"text",success:function(b){var c=b.match(/\{.*?\}/g);if(null!=c&&c.length>0){var f=c.pop();f.length>0&&(b=a.parseJSON(f))}if(0==b.length||0==b.result){var i=a("#gt_progress_errors");0==i.length&&(a(d).before('<div id="gt_progress_errors" class="gt_alert_bad"></div>'),i=a("#gt_progress_errors"));var j=void 0!==b.error?b.error:"error";return i.html(j),i.show(),h.prop("disabled",!1),h.val(M.util.get_string("run","block_gradetracker")),!1}a(d).val(g),a("#gt_report_time_left").text(""),a("#gt_progress_errors").hide(),e(b)},error:function(b){var c=a("#gt_progress_errors");return 0==c.length&&(a(d).before('<div id="gt_progress_errors" class="gt_alert_bad"></div>'),c=a("#gt_progress_errors")),c.html(b),c.show(),a("#gt_report_time_left").text(""),h.prop("disabled",!1),h.val(M.util.get_string("run","block_gradetracker")),!1}})},f.ajax_error=function(a){g.log("["+new Date+"] "+a),alert("["+new Date+"] "+a)},f.qual_picker={},f.qual_picker.filter=function(){var b=a("#gt_filter_qual_structure").val(),c=a("#gt_filter_qual_level").val(),d=a("#gt_filter_qual_subtype").val(),e=a("#gt_filter_qual_name").val(),g={structureID:b,levelID:c,subTypeID:d,name:e};a("#gt_filter_quals_loading").show(),a("#gt_filter_quals").html(""),f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:"get_filtered_quals",params:g},function(b){var c=a.parseJSON(b);a.each(c,function(b,c){if(0==a("#qual_opt_"+c.id).length&&0==a("#chosen_qual_opt_"+c.id).length){var d="<option id='qual_opt_"+c.id+"' value='"+c.id+"'>"+c.name+"</option>";a("#gt_filter_quals").append(d)}}),a("#gt_filter_quals_loading").hide()})},f.qual_picker.add=function(){var b=a("#gt_filter_quals option:selected");a.each(b,function(){var b=a(this).val();a(this).prop("selected",!1),a(this).attr("id","chosen_qual_opt_"+b),a("#chosen_quals").append(a(this)),a("#gt_chosen_quals_hidden_ids").append("<input type='hidden' id='hidden_qual_"+b+"' name='quals[]' value='"+b+"' />")})},f.qual_picker.remove=function(){var b=a("#chosen_quals option:selected");a.each(b,function(){var b=a(this).val();a(this).prop("selected",!1),a("#gt_filter_quals").append(a(this)),a("#hidden_qual_"+b).remove()})},f.grades={},f.grades.recalculate=function(b,c){if(a("#loading_"+c).show(),"target"==b)var d="get_refreshed_target_grades",e="stud_target_grade_view_"+c+"_",g="stud_target_grade_edit_"+c+"_",h="stud_weighted_target_grade_view_"+c+"_";else{if("aspirational"!=b)return a("#loading_"+c).hide(),!1;var d="get_refreshed_aspirational_grades",e="stud_aspirational_grade_view_"+c+"_",g="stud_aspirational_grade_edit_"+c+"_"}var i={qualID:c};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",{action:d,params:i},function(d){var f=a.parseJSON(d);a.each(f,function(c,d){var f="#"+e+c,i="#"+g+c,j="#"+h+c;if("target"==b){var k=d.target;if(1==k.result?(a(f).text(k.grade),0!==k.error&&""!==k.error&&void 0!==k.error&&a(f).append('<small style="color:red";><br>'+k.error+"</small>"),a(i+" select").val(k.gradeID),a(a(f).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(f).html('<span style="color:red;">'+k.error+"</span>"),a(i+" select").val(""),a(a(f).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3)),void 0!==d.weighted){var k=d.weighted;1==k.result?(a(j).text(k.grade),0!==k.error&&""!==k.error&&void 0!==k.error&&a(j).append('<small style="color:red";><br>'+k.error+"</small>"),a(a(j).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(j).html('<span style="color:red;">'+k.error+"</span>"),a(a(j).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3))}}else 1==d.result?(a(f).text(d.grade),0!==d.error&&""!==d.error&&void 0!==d.error&&a(f).append('<small style="color:red";><br>'+d.error+"</small>"),a(i+" select").val(d.gradeID),a(a(f).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3)):(a(f).html('<span style="color:red;">'+d.error+"</span>"),a(i+" select").val(""),a(a(f).parents("td")[0]).effect("highlight",{color:"#f24c3d"},3e3))}),gtRefreshReportTable(c),a("#loading_"+c).hide()})},f.grades.update=function(b,c,d,e){a("#loading_"+d).show();var g="stud_"+b+"_grade_view_"+d+"_",h={sID:c,qID:d,awardID:e,type:b};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/update.php",{action:"update_user_grade",params:h},function(b){var e=a.parseJSON(b),f="#"+g+c;a(f).text(e.grade),a(a(f).parents("td")[0]).effect("highlight",{color:"#ccff66"},3e3),a("#loading_"+d).hide()})},f.grades.toggle=function(b,c){var d=".stud_"+b+"_grade_view_"+c,e=".stud_"+b+"_grade_edit_"+c;a(d).toggle(),a(e).toggle()},f.grades.refresh_predicted=function(b){a("#loading_"+b).show();var c={action:"get_refreshed_predicted_grades",params:{qualID:b}};f.ajax(M.cfg.wwwroot+"/blocks/gradetracker/ajax/get.php",c,function(c){c=a.parseJSON(c),a.each(c,function(c,d){if(a("#gt_qualAward_Q"+b+"_S"+c+" > div").length>0)var e="#gt_qualAward_Q"+b+"_S"+c+" > div";else var e="#gt_qualAward_Q"+b+"_S"+c;void 0!==d["final"]&&d["final"]!==M.util.get_string("na","block_gradetracker")?a(e).text(d["final"]+" (Final)").effect("highlight",{color:"#ccff66"},3e3):void 0!==d.average&&d.average!==M.util.get_string("na","block_gradetracker")?a(e).text(d.average+" (Average)").effect("highlight",{color:"#ccff66"},3e3):a(e).text(M.util.get_string("na","block_gradetracker")).effect("highlight",{color:"#ccff66"},3e3)}),a("#loading_"+b).hide()})},f.toggle_disabled=function(b,c){a(b).removeProp("disabled"),a(b).removeAttr("disabled"),a(c).prop("disabled",!0),a(c).attr("disabled","");var d=b.substr(1,b.length);a("#"+d+"_enabled").attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/on.png");var e=c.substr(1,c.length);a("#"+e+"_enabled").attr("src",M.cfg.wwwroot+"/blocks/gradetracker/pix/off.png")},f.isKeyPressed=function(a){return a in f.keyMap?f.keyMap[a]:null},window.GT=f;var g={};return g.scripts=f,g.log=function(a){console.log("[GT] "+(new Date).toTimeString().split(" ")[0]+": "+a)},g.init=function(){f.init(),g.log("Loaded gt.js")},g});