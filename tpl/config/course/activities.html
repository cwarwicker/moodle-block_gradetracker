<?php if(!defined('BCGT')) exit; ?>

<?php echo (!empty($MSGS['errors'])) ? gt_error_alert_box($MSGS['errors']) : '' ?>
<?php echo (!empty($MSGS['success'])) ? gt_success_alert_box($MSGS['success']) : '' ?>

<div class='gt_form_panel'>

    <div class='gt_form_panel_heading'>
        <?php echo $Course->getName() ?> : <?php echo $string['activities'] ?>
    </div>

    <div class='gt_form_panel_body'>

        <?php if ($modLinks): ?>

        <div id="gt_course_activities_left">

            <ul class="gt_vertical_menu">
                <li><a id="_overview" href="#" class="gt_show_activity_section" section="#gt_activities_section_overview" hide=".gt_section"><?php echo $string['overview'] ?></a></li>
                <li><a id="_byactivity" href="#" class="gt_show_activity_section" section="#gt_activities_section_byactivity" hide=".gt_section"><?php echo $string['byactivity'] ?></a></li>
                <li><a id="_byunits" href="#" class="gt_show_activity_section selected" section="#gt_activities_section_byunits" hide=".gt_section"><?php echo $string['byunitscriteria'] ?></a></li>
            </ul>

        </div>

        <div id="gt_course_activities_right">

            <div id="gt_activities_section_overview" class="gt_section" style="display:none;">

                <ul class="gt_horizontal_menu">
                     <?php if($courseQuals): ?>
                        <?php foreach($courseQuals as $qual): ?>
                            <li><a href="#" class="gt_show_activity_section" section="#gt_activities_overview_<?php echo $qual->getID() ?>" hide=".gt_activities_overview_section"><?php echo $qual->getDisplayName() ?></a></li>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </ul>

                <br>
                <table id='gt_activities_overview_key'>
                    <tr>
                        <th colspan='3'><?php echo $string['key'] ?></th>
                    </tr>
                    <tr>
                        <td><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/tick_round.png" /> - <?php echo $string['activities:overview:tick:desc'] ?></td>
                        <td><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/cross_round.png" /> - <?php echo $string['activities:overview:cross:desc'] ?></td>
                        <td><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/warning_round.png" /> - <?php echo $string['activities:overview:warning:desc'] ?></td>
                    </tr>
                </table>

                <br><br>

                <?php if($courseQuals): ?>

                    <?php foreach($courseQuals as $qual): ?>

                        <div id="gt_activities_overview_<?php echo $qual->getID() ?>" class="gt_activities_overview_section" style="display:none;">

                            <table class='gt_activities_overview'>
                                <tr>
                                    <th><?php echo $string['unit'] ?></th>
                                    <?php if( ($criteriaNames = $qual->getHeaderCriteriaNames()) ): ?>
                                        <?php foreach($criteriaNames as $criterion): ?>
                                            <th><?php echo $criterion['name'] ?></th>
                                            <?php if ($criterion['sub']): ?>
                                                <?php foreach($criterion['sub'] as $sub): ?>
                                                    <th><?php echo $sub ?></th>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </tr>

                                <?php if ( ($units = $qual->getUnits()) ): ?>
                                    <?php foreach($units as $qualUnit): ?>
                                        <tr>
                                            <td><?php echo $qualUnit->getDisplayName() ?></td>
                                            <?php foreach($criteriaNames as $crit): ?>

                                                <?php if ( ($criterion = $qualUnit->getCriterionByName($crit['name'])) !== false ): ?>
                                                    <td class='gt_activities_overview_criterion' qID='<?php echo $qual->getID() ?>' uID='<?php echo $qualUnit->getID() ?>' cID='<?php echo $criterion->getID() ?>'><?php echo $criterion->getActivityOverviewCell( $qual->getID() ) ?></td>
                                                <?php else: ?>
                                                    <td class='gt_empty'></td>
                                                <?php endif; ?>

                                                <?php if ($crit['sub']): ?>
                                                    <?php foreach($crit['sub'] as $sub): ?>
                                                        <?php if ( ($criterion = $qualUnit->getCriterionByName($sub)) !== false ): ?>
                                                            <td class='gt_activities_overview_criterion' qID='<?php echo $qual->getID() ?>' uID='<?php echo $qualUnit->getID() ?>' cID='<?php echo $criterion->getID() ?>'><?php echo $criterion->getActivityOverviewCell( $qual->getID() ) ?></td>
                                                        <?php else: ?>
                                                            <td class='gt_empty'></td>
                                                        <?php endif; ?>
                                                    <?php endforeach; ?>
                                                <?php endif; ?>


                                            <?php endforeach; ?>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>

                            </table>

                        </div>

                    <?php endforeach; ?>

                    <br>
                    <div class='c'><img id='gt_activities_overview_loading' style='display:none;' src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/ajax-loader.gif" alt="<?php echo $string['loading'] ?>" /></div>
                    <br>

                    <div id='gt_activities_overview_details' style='display:none'>
                        <table>
                            <tr>
                                <td><?php echo $string['qualification'] ?>:</td>
                                <td id='gt_activities_overview_details_qual'></td>
                            </tr>
                            <tr>
                                <td><?php echo $string['unit'] ?>:</td>
                                <td id='gt_activities_overview_details_unit'></td>
                            </tr>
                            <tr>
                                <td><?php echo $string['criterion'] ?>:</td>
                                <td id='gt_activities_overview_details_criterion'></td>
                            </tr>
                            <tr>
                                <td colspan='2'><?php echo $string['activitylinks'] ?>:</td>
                            </tr>

                        </table>
                    </div>

                <?php endif; ?>

            </div>

            <div id="gt_activities_section_byactivity" class="gt_section" style="display:none;">

                <table id="gt_course_activities" class="gt_config" style="width:100%;">

                    <tr>
                        <th></th>
                        <th></th>
                        <th><?php echo $string['activity'] ?></th>
                        <th><?php echo $string['duedate'] ?></th>
                        <th><?php echo $string['criteria'] ?></th>
                    </tr>

                    <?php if ($activities): ?>

                        <?php foreach($activities as $activityModule): ?>

                            <?php if ($activityModule->getRecordParts()): ?>

                                <?php foreach($activityModule->getRecordParts() as $part): ?>

                                    <tr>
                                        <td><a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=add&cmid=<?php echo $activityModule->getCourseModID() ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/plus.png" alt="add" /></a></td>
                                        <td><img src="<?php echo $activityModule->getModIcon() ?>" alt="<?php echo $activityModule->getModName() ?>" /></td>
                                        <td><a href="<?php echo $CFG->wwwroot ?>/mod/<?php echo $activityModule->getModName() ?>/view.php?id=<?php echo $activityModule->getCourseModID() ?>"><?php echo $activityModule->getRecordName() ?> (<?php echo $part->name ?>)</a></td>
                                        <td><?php echo $activityModule->getRecordDueDate('D jS M Y, H:i', $part->id) ?></td>
                                        <td>
                                            <?php foreach( (array)$activityModule->getQualsOnModule($part->id) as $qual): ?>
                                                <table class="gt_course_activities_qual_table">

                                                    <tr>
                                                        <th colspan="<?php echo $activityModule->countCriteriaOnModule($qual->getID(), false, $part->id) ?>"><?php echo $qual->getDisplayName() ?> <a href='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=delete&cmid=<?php echo $activityModule->getCourseModID() ?>&part=<?php echo $part->id ?>&qualid=<?php echo $qual->getID() ?>'><img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png' /></a></th>
                                                    </tr>

                                                    <?php foreach( (array)$activityModule->getUnitsOnModule($qual->getID()) as $unit): ?>

                                                        <?php if ($criteria = $activityModule->getCriteriaOnModule($qual->getID(), $unit, $part->id)): ?>
                                                            <tr>
                                                                <th class="gt_unit_name" colspan="<?php echo $activityModule->countCriteriaOnModule($qual->getID(), false, $part->id) ?>"><?php echo $unit->getDisplayName() ?></th>
                                                            </tr>

                                                            <tr>
                                                                <?php foreach( $criteria as $crit): ?>
                                                                    <td><?php echo $crit->getName() ?></td>
                                                                <?php endforeach; ?>
                                                            </tr>
                                                        <?php endif; ?>

                                                    <?php endforeach; ?>

                                                </table>
                                            <?php endforeach; ?>
                                        </td>
                                    </tr>

                                <?php endforeach; ?>

                            <?php else: ?>

                                <tr>
                                    <td><a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=add&cmid=<?php echo $activityModule->getCourseModID() ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/plus.png" alt="add" /></a></td>
                                    <td><img src="<?php echo $activityModule->getModIcon() ?>" alt="<?php echo $activityModule->getModName() ?>" /></td>
                                    <td><a href="<?php echo $CFG->wwwroot ?>/mod/<?php echo $activityModule->getModName() ?>/view.php?id=<?php echo $activityModule->getCourseModID() ?>"><?php echo $activityModule->getRecordName() ?></a></td>
                                    <td><?php echo $activityModule->getRecordDueDate('D jS M Y, H:i') ?></td>
                                    <td>
                                        <?php foreach( (array)$activityModule->getQualsOnModule() as $qual): ?>
                                            <table class="gt_course_activities_qual_table">

                                                <tr>
                                                    <th colspan="<?php echo $activityModule->countCriteriaOnModule($qual->getID()) ?>"><?php echo $qual->getDisplayName() ?> <a href='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=delete&cmid=<?php echo $activityModule->getCourseModID() ?>&qualid=<?php echo $qual->getID() ?>'><img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png' /></a></th>
                                                </tr>

                                                <?php foreach( (array)$activityModule->getUnitsOnModule($qual->getID()) as $unit): ?>

                                                    <tr>
                                                        <th class="gt_unit_name" colspan="<?php echo $activityModule->countCriteriaOnModule($qual->getID()) ?>"><?php echo $unit->getDisplayName() ?></th>
                                                    </tr>

                                                    <tr>
                                                        <?php foreach( (array)$activityModule->getCriteriaOnModule($qual->getID(), $unit) as $crit): ?>
                                                            <td><?php echo $crit->getName() ?></td>
                                                        <?php endforeach; ?>
                                                    </tr>

                                                <?php endforeach; ?>

                                            </table>

                                        <?php endforeach; ?>

                                    </td>

                                </tr>

                            <?php endif; ?>

                        <?php endforeach; ?>

                    <?php endif; ?>

                </table>

            </div>

            <div id="gt_activities_section_byunits" class="gt_section">

                <table id="gt_course_activities" class="gt_config" style="width:100%;">

                    <tr>
                        <th></th>
                        <th><?php echo $string['unit'] ?></th>
                        <th><?php echo $string['activities'] ?></th>
                    </tr>

                    <?php if ($courseQuals): ?>

                        <?php foreach($courseQuals as $qual): ?>

                            <tr>
                                <th colspan="3"><?php echo $qual->getDisplayName() ?></th>
                            </tr>

                            <?php if ($qual->getUnits()): ?>

                                <?php foreach($qual->getUnits() as $unit): ?>
                                    <tr>
                                        <td><a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=add&qualid=<?php echo $qual->getID() ?>&unitid=<?php echo $unit->getID() ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/plus.png" alt="add" /></a></td>
                                        <td class="gt_left"><?php echo $unit->getDisplayName() ?></td>
                                        <td>
                                            <?php foreach((array)\block_gradetracker\ModuleLink::getModulesOnUnit($qual->getID(), $unit->getID(), $Course->id) as $unitMod): ?>

                                                <?php if ($unitMod->getRecordParts()): ?>

                                                    <?php foreach($unitMod->getRecordParts() as $part): ?>

                                                        <?php if ($criteria = $unitMod->getCriteriaOnModule($qual->getID(), $unit, $part->id)): ?>

                                                            <table class="gt_course_activities_qual_table">

                                                                <tr>
                                                                    <th colspan="<?php echo $unitMod->countCriteriaOnModule($qual->getID(), $unit, $part->id) ?>">
                                                                        <img class="gt_16" src="<?php echo $unitMod->getModIcon() ?>" alt="<?php echo $unitMod->getModName() ?>" />
                                                                        <?php echo $unitMod->getRecordName() ?>
                                                                        (<?php echo $part->name ?>) -
                                                                        <?php echo $unitMod->getRecordDueDate('D jS M Y, H:i', $part->id) ?>
                                                                        <a href='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=delete&cmid=<?php echo $unitMod->getCourseModID() ?>&part=<?php echo $part->id ?>&qualid=<?php echo $qual->getID() ?>&unitID=<?php echo $unit->getID() ?>'><img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png' /></a>
                                                                    </th>
                                                                </tr>

                                                                <tr>
                                                                    <?php foreach( $criteria as $crit): ?>
                                                                        <td><?php echo $crit->getName() ?></td>
                                                                    <?php endforeach; ?>
                                                                </tr>

                                                            </table>

                                                        <?php endif; ?>

                                                    <?php endforeach; ?>

                                                <?php else: ?>

                                                    <table class="gt_course_activities_qual_table">

                                                        <tr>
                                                            <th colspan="<?php echo $unitMod->countCriteriaOnModule($qual->getID(), $unit) ?>">
                                                                <img class="gt_16" src="<?php echo $unitMod->getModIcon() ?>" alt="<?php echo $unitMod->getModName() ?>" />
                                                                <?php echo $unitMod->getRecordName() ?> -
                                                                <?php echo $unitMod->getRecordDueDate('D jS M Y, H:i') ?>
                                                                <a href='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities&page=delete&cmid=<?php echo $unitMod->getCourseModID() ?>&qualid=<?php echo $qual->getID() ?>&unitid=<?php echo $unit->getID() ?>'><img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png' /></a>
                                                            </th>
                                                        </tr>

                                                        <tr>
                                                            <?php foreach( (array)$unitMod->getCriteriaOnModule($qual->getID(), $unit) as $crit): ?>
                                                                <td><?php echo $crit->getName() ?></td>
                                                            <?php endforeach; ?>
                                                        </tr>

                                                    </table>

                                                <?php endif; ?>

                                            <?php endforeach; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>

                            <?php endif; ?>

                        <?php endforeach; ?>

                    <?php endif; ?>


                </table>

            </div>

        </div>

        <br class="gt_cl">

        <?php else: ?>

        <p><?php echo $string['nomodlinks'] ?></p>

        <?php endif; ?>

    </div>

</div>

<input type="hidden" id="gt_cid" value="<?php echo $Course->id ?>" />
