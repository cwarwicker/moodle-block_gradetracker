<?php if(!defined('BCGT')) exit; ?>

<div class='gt_form_panel'>

    <div class='gt_form_panel_heading'>
        <?php echo $Course->getName() ?> : <?php echo $string['breadcrumbs:config:course:activities:add'] ?>
    </div>

    <div class='gt_form_panel_body'>

        <form action="" method="post">
            <input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />

            <input type="hidden" name="courseID" id="gt_cid" value="<?php echo $Course->id ?>" />

            <?php echo (!empty($MSGS['errors'])) ? gt_error_alert_box($MSGS['errors']) : '' ?>
            <?php echo (!empty($MSGS['success'])) ? gt_success_alert_box($MSGS['success']) : '' ?>

            <p class="gt_c">
                <input type="submit" class="gt_btn gt_btn_small gt_blue" name="submit_activity_links" value="<?php echo $string['save'] ?>">
                <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities" class="gt_btn gt_btn_small gt_red"><?php echo $string['back'] ?></a>
            </p>

            <?php if ($viewBy == 'cm'): ?>

                <input type="hidden" name="coursemoduleid" id="gt_cmid" value="<?php echo $cmID ?>" />

                <table id="gt_activity_links">

                    <tr>
                        <td><?php echo $string['activity'] ?></td>
                        <td>
                            <b><img src="<?php echo $moduleActivity->getModIcon() ?>" alt="<?php echo $moduleActivity->getModName() ?>" /> <?php echo $moduleActivity->getRecordName() ?> (<?php echo $moduleActivity->getModName() ?>)</b>
                            <br><br>
                        </td>
                    </tr>

                    <?php if ($courseQuals): ?>

                        <?php foreach($courseQuals as $qual): ?>

                            <tr>
                                <td><?php echo $qual->getDisplayName() ?></td>
                                <td class="gt_mod_hook_activities">
                                    <?php if ($qual->getUnits()): ?>

                                        <select id='gt_mod_hook_<?php echo $qual->getID() ?>_units_select' class='gt_mod_hook_units' qualID='<?php echo $qual->getID() ?>'>
                                            <option value=""></option>
                                            <?php foreach($qual->getUnits() as $unit): ?>
                                                <option value="<?php echo $unit->getID() ?>" <?php echo (array_key_exists($unit->getID(), $unitsLinked[$qual->getID()])) ? 'disabled' : ''; ?> ><?php echo $unit->getDisplayName() ?></option>
                                            <?php endforeach; ?>
                                        </select>

                                        <span id='gt_mod_hook_loader_<?php echo $qual->getID() ?>' class='gt_hidden'><img src="<?php echo gt_image_url('i/loading_small') ?>" alt='loading' /></span>
                                        <br><br>

                                         <div id='gt_mod_hook_qual_units_<?php echo $qual->getID() ?>'>

                                             <?php if ($unitsLinked[$qual->getID()]): ?>

                                                <?php foreach($unitsLinked[$qual->getID()] as $unit): ?>

                                                    <?php $criteria = $unit->sortCriteria(false, true); ?>

                                                        <div id='gt_hooked_unit_<?php echo $qual->getID() ?>_<?php echo $unit->getID() ?>' class='gt_hooked_unit'>

                                                            <?php echo $unit->getDisplayName() ?> <a href='#' class='gt_mod_hook_delete_unit' qualID='<?php echo $qual->getID() ?>' unitID='<?php echo $unit->getID() ?>'><img src="<?php echo gt_image_url('t/delete') ?>" /></a><br>

                                                            <table class='gt_c gt_hook_unit_criteria'>
                                                                <tr>
                                                                    <?php if ($criteria): ?>
                                                                        <?php foreach($criteria as $criterion): ?>
                                                                            <th><?php echo $criterion->getName() ?></th>
                                                                        <?php endforeach; ?>
                                                                    <?php endif; ?>
                                                                </tr>

                                                                <tr>
                                                                    <?php if ($criteria): ?>
                                                                        <?php foreach($criteria as $criterion): ?>
                                                                            <td>
                                                                                <?php if ($moduleActivity->getRecordParts()): ?>
                                                                                    <select name="gt_criteria[<?php echo $qual->getID() ?>][<?php echo $unit->getID() ?>][<?php echo $criterion->getID() ?>]">
                                                                                        <option value="0"></option>
                                                                                        <?php foreach($moduleActivity->getRecordParts() as $part): ?>
                                                                                            <option value="<?php echo $part->id ?>" <?php echo (\block_gradetracker\Activity::checkExists($cmID, $qual->getID(), $unit->getID(), $criterion->getID(), $part->id)) ? 'selected' : ''; ?> ><?php echo $part->name ?></option>
                                                                                        <?php endforeach; ?>
                                                                                    </select>
                                                                                <?php else: ?>
                                                                                    <input type='checkbox' name='gt_criteria[<?php echo $qual->getID() ?>][<?php echo $unit->getID() ?>][<?php echo $criterion->getID() ?>]' <?php echo ( (\block_gradetracker\Activity::checkExists($cmID, $qual->getID(), $unit->getID(), $criterion->getID())) ? 'checked' : '' )  ?> />
                                                                                <?php endif; ?>
                                                                            </td>
                                                                        <?php endforeach; ?>
                                                                    <?php endif; ?>
                                                                </tr>
                                                            </table>

                                                        </div>

                                                <?php endforeach; ?>

                                             <?php endif; ?>

                                         </div>

                                    <?php else: ?>
                                        <?php echo $string['qualnounits'] ?>
                                    <?php endif; ?>
                                </td>
                            </tr>

                        <?php endforeach; ?>

                    <?php else: ?>
                        <?php echo $string['coursenoquals'] ?>
                    <?php endif; ?>

                </table>

            <?php elseif ($viewBy == 'unit'): ?>

                <table id="gt_activity_links">

                    <tr>
                        <td><?php echo $string['qualification'] ?></td>
                        <td>
                            <select name="qualid" class="gt_mod_change_qual_units">
                                <option value=""></option>
                                <?php if ($courseQuals): ?>
                                    <?php foreach($courseQuals as $courseQual): ?>
                                        <option value="<?php echo $courseQual->getID() ?>" <?php echo ($qual->getID() == $courseQual->getID()) ? 'selected' : ''; ?> ><?php echo $courseQual->getDisplayName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td><?php echo $string['unit'] ?></td>
                        <td>
                            <select name="unitid" id="gt_mod_change_qual_units_units">
                                <option value=""></option>
                                <?php if ($courseQuals): ?>
                                    <?php foreach($courseQuals as $courseQual): ?>
                                        <?php if ($courseQual->getUnits()): ?>
                                            <?php foreach($courseQual->getUnits() as $qualUnit): ?>
                                                <option class="AQU Q_<?php echo $courseQual->getID() ?> <?php echo ($courseQual->getID() <> $qual->getID()) ? 'gt_hidden' : ''; ?> " value="<?php echo $qualUnit->getID() ?>" <?php echo ($unit->getID() == $qualUnit->getID()) ? 'selected' : ''; ?> ><?php echo $qualUnit->getDisplayName() ?></option>
                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                    <?php endforeach; ?>
                                <?php endif; ?>

                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td><?php echo $string['activity'] ?></td>
                        <td>
                            <select name="coursemoduleid" class="gt_mod_activity">
                                <option value=""></option>
                                <?php if ($activities): ?>
                                    <?php foreach($activities as $activity): ?>
                                        <option value="<?php echo $activity->getCourseModID() ?>" <?php echo (array_key_exists($activity->getCourseModID(), $unitActivities)) ? 'disabled' : ''; ?> ><?php echo $activity->getRecordName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                            <span id='gt_mod_hook_loader_activity' class='gt_hidden'><img src="<?php echo gt_image_url('i/loading_small') ?>" alt='loading' /></span>
                        </td>
                    </tr>

                    <tr>
                        <td></td>
                        <td id="gt_mod_hook_activities">

                            <?php if ($unitActivities): ?>
                                <?php foreach($unitActivities as $activity): ?>
                                    <div id="gt_hooked_activity_<?php echo $activity->getCourseModID() ?>" class='gt_hooked_unit'>
                                        <img src="<?php echo $activity->getModIcon() ?>"> <?php echo $activity->getRecordName() ?>
                                        <a href="#" class="gt_mod_hook_delete_activity" cmid="<?php echo $activity->getCourseModID() ?>">
                                            <img src="<?php echo gt_image_url('t/delete') ?>">
                                        </a>
                                        <br>
                                        <table class="gt_c gt_hook_unit_criteria">
                                            <tr>
                                                <?php if ($criteria): ?>
                                                    <?php foreach($criteria as $crit): ?>
                                                        <th><?php echo $crit->getName() ?></th>
                                                    <?php endforeach; ?>
                                                <?php endif; ?>
                                            </tr>
                                            <tr>
                                                <?php if ($criteria): ?>
                                                    <?php foreach($criteria as $crit): ?>
                                                        <td>
                                                            <?php if ($activity->getRecordParts()): ?>
                                                                <select name="gt_criteria[<?php echo $activity->getCourseModID() ?>][<?php echo $crit->getID() ?>]">
                                                                    <option value="0"></option>
                                                                    <?php foreach($activity->getRecordParts() as $part): ?>
                                                                        <option value="<?php echo $part->id ?>" <?php echo (\block_gradetracker\Activity::checkExists($activity->getCourseModID(), $qual->getID(), $unit->getID(), $crit->getID(), $part->id)) ? 'selected' : ''; ?> ><?php echo $part->name ?></option>
                                                                    <?php endforeach; ?>
                                                                </select>
                                                            <?php else: ?>
                                                                <input type="checkbox" name="gt_criteria[<?php echo $activity->getCourseModID() ?>][<?php echo $crit->getID() ?>]" <?php echo (\block_gradetracker\Activity::checkExists($activity->getCourseModID(), $qual->getID(), $unit->getID(), $crit->getID())) ? 'checked' : ''; ?> >
                                                            <?php endif; ?>
                                                        </td>
                                                    <?php endforeach; ?>
                                                <?php endif; ?>
                                            </tr>
                                        </table>
                                    </div>
                                <?php endforeach; ?>
                            <?php endif; ?>

                        </td>
                    </tr>

                </table>

            <?php endif; ?>

            <p class="gt_c">
                <input type="submit" class="gt_btn gt_btn_small gt_blue" name="submit_activity_links" value="<?php echo $string['save'] ?>">
                <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&id=<?php echo $Course->id ?>&section=activities" class="gt_btn gt_btn_small gt_red"><?php echo $string['back'] ?></a>
            </p>

        </form>

    </div>


</div>