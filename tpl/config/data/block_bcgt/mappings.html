<?php if(!defined('BCGT')) exit; ?>

<?= (!empty($MSGS['errors'])) ? \gt_error_alert_box($MSGS['errors']) : '' ?>
<?= (!empty($MSGS['success'])) ? \gt_success_alert_box($MSGS['success']) : '' ?>

<div class="gt_full_page">

    <div class="gt_form_panel">

        <div class="gt_form_panel_heading"><?= $string['blockbcgtdata'] ?> - <?= $string['datamapping'] ?></div>

        <div class="gt_form_panel_body">
            
            <p><?= $string['blockbcgtdata:mapping:desc'] ?></p>

            <form action="" method="post">

                <table class='gt_config'>

                    <tr>
                        <th colspan='3'><?= $string['blockbcgtdata:qualfam'] ?></th>
                        <th colspan='3'><?= $string['blockbcgtdata:unitgrademap'] ?></th>
                        <th colspan='3'><?= $string['blockbcgtdata:critgrademap'] ?></th>
                    </tr>

                    <tr>

                        <th><?= $string['old'] ?></th>
                        <th></th>
                        <th><?= $string['new'] ?></th>

                        <th><?= $string['old'] ?></th>
                        <th></th>
                        <th><?= $string['new'] ?></th>

                        <th><?= $string['old'] ?></th>
                        <th></th>
                        <th><?= $string['new'] ?></th>

                    </tr>

                    <tr>

                        <td>BTEC</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][btec]' onchange="gt_block_bcgt_switch_qual_structure_mapping('btec', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'btec')) && $val == $structure->getID() ) ? 'selected' : '' ?> ><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>

                        <td>PMD<br>
                            Pass/Fail<br>
                            L1/L2 First (2013)
                        </td>
                        <td> <=> </td>
                        <td>
                            <select id='u_btec_pmd' class="gt_block_bcgt_mapping_btec_unit_grades" name="block_bcgt_structure_maps[unit][btec][pmd]"></select><br>
                            <select id='u_btec_pf' class="gt_block_bcgt_mapping_btec_unit_grades" name="block_bcgt_structure_maps[unit][btec][pf]"></select><br>
                            <select id='u_btec_l1l2' class="gt_block_bcgt_mapping_btec_unit_grades" name="block_bcgt_structure_maps[unit][btec][l1l2]"></select>
                        </td>

                        <td>Achieved</td>
                        <td> <=> </td>
                        <td>
                            <select id='c_btec_achieved' class="gt_block_bcgt_mapping_btec_crit_grades" name="block_bcgt_structure_maps[crit][btec][achieved]"></select><br>
                        </td>

                    </tr>


                    <tr>

                        <td>City & Guilds</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][cg]' onchange="gt_block_bcgt_switch_qual_structure_mapping('cg', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'cg')) && $val == $structure->getID() ) ? 'selected' : '' ?>><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>


                        <td>
                            PMD<br>
                            PCD<br>
                            Pass Only
                        </td>
                        <td>
                            <=><br>
                            <=><br>
                            <=>
                        </td>
                        <td>
                            <select id='u_cg_pmd' class="gt_block_bcgt_mapping_cg_unit_grades" name="block_bcgt_structure_maps[unit][cg][pmd]"></select><br>
                            <select id='u_cg_pcd' class="gt_block_bcgt_mapping_cg_unit_grades" name="block_bcgt_structure_maps[unit][cg][pcd]"></select><br>
                            <select id='u_cg_pass' class="gt_block_bcgt_mapping_cg_unit_grades" name="block_bcgt_structure_maps[unit][cg][pass]"></select>
                        </td>


                        <td>
                            PMD<br>
                            PCD<br>
                            Pass Only<br>
                            Date<br>
                            Free Text
                        </td>
                        <td>
                            <=><br>
                            <=><br>
                            <=><br>
                            <=><br>
                            <=>
                        </td>
                        <td>
                            <select id='c_cg_pmd' class="gt_block_bcgt_mapping_cg_crit_grades" name="block_bcgt_structure_maps[crit][cg][pmd]"></select><br>
                            <select id='c_cg_pcd' class="gt_block_bcgt_mapping_cg_crit_grades" name="block_bcgt_structure_maps[crit][cg][pcd]"></select><br>
                            <select id='c_cg_pass' class="gt_block_bcgt_mapping_cg_crit_grades" name="block_bcgt_structure_maps[crit][cg][pass]"></select><br>
                            <select id='c_cg_date' class="gt_block_bcgt_mapping_cg_crit_grades" name="block_bcgt_structure_maps[crit][cg][date]"></select><br>
                            <select id='c_cg_freetext' class="gt_block_bcgt_mapping_cg_crit_grades" name="block_bcgt_structure_maps[crit][cg][freetext]"></select>
                        </td>

                    </tr>



                    <tr>

                        <td>City & Guilds - Hair & Beauty (VRQ)</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][cghbvrq]' onchange="gt_block_bcgt_switch_qual_structure_mapping('cghbvrq', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'cghbvrq')) && $val == $structure->getID() ) ? 'selected' : '' ?>><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>


                        <td>
                            PMD
                        </td>
                        <td>
                            <=>
                        </td>
                        <td>
                            <select id='u_cbhbvrq_pmd' class="gt_block_bcgt_mapping_cghbvrq_unit_grades" name="block_bcgt_structure_maps[unit][cghbvrq][pmd]"></select><br>
                        </td>


                        <td>
                            PMD<br>
                            Pass Only
                        </td>
                        <td>
                            <=><br>
                            <=>
                        </td>
                        <td>
                            <select id='c_cghbvrq_pmd' class="gt_block_bcgt_mapping_cghbvrq_crit_grades" name="block_bcgt_structure_maps[crit][cghbvrq][pmd]"></select><br>
                            <select id='c_cghbvrq_pass' class="gt_block_bcgt_mapping_cghbvrq_crit_grades" name="block_bcgt_structure_maps[crit][cghbvrq][pass]"></select>
                        </td>

                    </tr>



                     <tr>

                        <td>City & Guilds - Hair & Beauty (NVQ)</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][cghbnvq]' onchange="gt_block_bcgt_switch_qual_structure_mapping('cghbnvq', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'cghbnvq')) && $val == $structure->getID() ) ? 'selected' : '' ?>><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>


                        <td>
                            Pass Only
                        </td>
                        <td>
                            <=>
                        </td>
                        <td>
                            <select id='u_cghbnvq_pass' class="gt_block_bcgt_mapping_cghbnvq_unit_grades" name="block_bcgt_structure_maps[unit][cghbnvq][pass]"></select><br>
                        </td>


                        <td>
                            Pass Only
                        </td>
                        <td>
                            <=>
                        </td>
                        <td>
                            <select id='c_cghbnvq_pass' class="gt_block_bcgt_mapping_cghbnvq_crit_grades" name="block_bcgt_structure_maps[crit][cghbnvq][pass]"></select>
                        </td>

                    </tr>




                    <tr>

                        <td>A Level</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][alvl]' onchange="gt_block_bcgt_switch_qual_structure_mapping('alvl', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'alvl')) && $val == $structure->getID() ) ? 'selected' : '' ?>><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>

                        <td colspan="3">-</td>

                        <td colspan="3">-</td>

                    </tr>



                    <tr>

                        <td>GCSE</td>
                        <td> <=> </td>
                        <td>
                            <select name='block_bcgt_structure_maps[qual][gcse]' onchange="gt_block_bcgt_switch_qual_structure_mapping('gcse', this.value);return false;">
                                <option value=""></option>
                                <?php if ($allStructures): ?>
                                    <?php foreach($allStructures as $structure): ?>
                                        <option value="<?= $structure->getID() ?>" <?= ( ($val = $oldGT->getMappingNewValue('qual_structure', 'gcse')) && $val == $structure->getID() ) ? 'selected' : '' ?>><?= $structure->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </td>

                        <td colspan="3">-</td>

                        <td colspan="3">-</td>

                    </tr>

                </table>

                <br><br>

                <input type="submit" class="gt_btn gt_blue" name="save_mappings" value="<?= $string['save'] ?>" />

            </form>
            
        </div>
        
    </div>
    
</div>









<script>
    
    // Unit grading structures
    var qualStructureUnitGradingStructures = [];
    <?php if ($allStructures): ?>
        <?php foreach($allStructures as $structure): ?>
            <?php if( ($unitGradingStructures = $structure->getUnitGradingStructures()) !== false ): ?>
                qualStructureUnitGradingStructures['<?= $structure->getID() ?>'] = [];
                <?php foreach($unitGradingStructures as $unitGradingStructure): ?>
                    qualStructureUnitGradingStructures['<?= $structure->getID() ?>'].push( {id: <?= $unitGradingStructure->getID() ?>, name: '<?= \gt_html($unitGradingStructure->getName()) ?>'} );
                <?php endforeach; ?>
            <?php endif; ?>
        <?php endforeach; ?>
    <?php endif; ?>
    
    // Criteria grading structures
    var qualStructureCritGradingStructures = [];
    <?php if ($allStructures): ?>
        <?php foreach($allStructures as $structure): ?>
            <?php if( ($critGradingStructures = $structure->getCriteriaGradingStructures()) !== false ): ?>
                qualStructureCritGradingStructures['<?= $structure->getID() ?>'] = [];
                <?php foreach($critGradingStructures as $critGradingStructure): ?>
                    qualStructureCritGradingStructures['<?= $structure->getID() ?>'].push( {id: <?= $critGradingStructure->getID() ?>, name: '<?= \gt_html($critGradingStructure->getName()) ?>'} );
                <?php endforeach; ?>
            <?php endif; ?>
        <?php endforeach; ?>
    <?php endif; ?>
    
    
    function gt_block_bcgt_switch_qual_structure_mapping(oldName, newID){
        
        // Clear existing options - unit grading structures
        $('.gt_block_bcgt_mapping_'+oldName+'_unit_grades').html('');
        $('.gt_block_bcgt_mapping_'+oldName+'_unit_grades').val('');
        
        // Add new options - unit grading structures
        var options = qualStructureUnitGradingStructures[newID];
        if (typeof options !== "undefined" && options.length > 0)
        {
            $.each(options, function(k, j){
                $('.gt_block_bcgt_mapping_'+oldName+'_unit_grades').append('<option value="'+j.id+'">'+j.name+'</option>');
            });
        }
        
        
        // Clear existing options - crit grading structures
        $('.gt_block_bcgt_mapping_'+oldName+'_crit_grades').html('');
        $('.gt_block_bcgt_mapping_'+oldName+'_crit_grades').val('');
        
        // Add new options - crit grading structures
        var options = qualStructureCritGradingStructures[newID];
        if (typeof options !== "undefined" && options.length > 0)
        {
            $.each(options, function(k, j){
                $('.gt_block_bcgt_mapping_'+oldName+'_crit_grades').append('<option value="'+j.id+'">'+j.name+'</option>');
            });
        }
        
        
    }
    
</script>

<script>
    var savedStructure = [];
    savedStructure['btec'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'btec')) ? $val : 0 ?>;
    savedStructure['cg'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'cg')) ? $val : 0 ?>;
    savedStructure['cghbvrq'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'cghbvrq')) ? $val : 0 ?>;
    savedStructure['cghbnvq'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'cghbnvq')) ? $val : 0 ?>;
    savedStructure['alvl'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'alvl')) ? $val : 0 ?>;
    savedStructure['gcse'] = <?= ($val = $oldGT->getMappingNewValue('qual_structure', 'gcse')) ? $val : 0 ?>;
    
    savedStructure['unit'] = [];
    savedStructure['crit'] = [];
    
    // BTEC
    if (savedStructure['btec'] > 0)
    {
        
        gt_block_bcgt_switch_qual_structure_mapping('btec', savedStructure['btec']);
        
        savedStructure['unit']['btec'] = [];
        savedStructure['crit']['btec'] = [];
        
        savedStructure['unit']['btec']['pmd'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_btec', 'pmd')) ? $val : 0 ?>;
        savedStructure['unit']['btec']['pf'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_btec', 'pf')) ? $val : 0 ?>;
        savedStructure['unit']['btec']['l1l2'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_btec', 'l1l2')) ? $val : 0 ?>;
        
        savedStructure['crit']['btec']['achieved'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_btec', 'achieved')) ? $val : 0 ?>;
        
        $('#u_btec_pmd').val( savedStructure['unit']['btec']['pmd'] );
        $('#u_btec_pf').val( savedStructure['unit']['btec']['pf'] );
        $('#u_btec_l1l2').val( savedStructure['unit']['btec']['l1l2'] );
        $('#c_btec_achieved').val( savedStructure['crit']['btec']['achieved'] );
        
    }
    
    // CG - General
    if (savedStructure['cg'] > 0)
    {
        
        gt_block_bcgt_switch_qual_structure_mapping('cg', savedStructure['cg']);
        
        savedStructure['unit']['cg'] = [];
        savedStructure['crit']['cg'] = [];
        
        savedStructure['unit']['cg']['pmd'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_cg', 'pmd')) ? $val : 0 ?>;
        savedStructure['unit']['cg']['pcd'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_cg', 'pcd')) ? $val : 0 ?>;
        savedStructure['unit']['cg']['pass'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_cg', 'pass')) ? $val : 0 ?>;
        
        savedStructure['crit']['cg']['pmd'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cg', 'pmd')) ? $val : 0 ?>;
        savedStructure['crit']['cg']['pcd'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cg', 'pcd')) ? $val : 0 ?>;
        savedStructure['crit']['cg']['pass'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cg', 'pass')) ? $val : 0 ?>;
        savedStructure['crit']['cg']['date'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cg', 'date')) ? $val : 0 ?>;
        savedStructure['crit']['cg']['freetext'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cg', 'freetext')) ? $val : 0 ?>;
        
        $('#u_cg_pmd').val( savedStructure['unit']['cg']['pmd'] );
        $('#u_cg_pcd').val( savedStructure['unit']['cg']['pcd'] );
        $('#u_cg_pass').val( savedStructure['unit']['cg']['pass'] );
        
        $('#c_cg_pmd').val( savedStructure['crit']['cg']['pmd'] );
        $('#c_cg_pcd').val( savedStructure['crit']['cg']['pcd'] );
        $('#c_cg_pass').val( savedStructure['crit']['cg']['pass'] );
        $('#c_cg_date').val( savedStructure['crit']['cg']['date'] );
        $('#c_cg_freetext').val( savedStructure['crit']['cg']['freetext'] );
        
    }
    
    // CG - Hair & Beauty VRQ
    if (savedStructure['cghbvrq'] > 0)
    {
        
        gt_block_bcgt_switch_qual_structure_mapping('cghbvrq', savedStructure['cghbvrq']);
        
        savedStructure['unit']['cghbvrq'] = [];
        savedStructure['crit']['cghbvrq'] = [];
        
        savedStructure['unit']['cghbvrq']['pmd'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_cghbvrq', 'pmd')) ? $val : 0 ?>;
        
        savedStructure['crit']['cghbvrq']['pmd'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cghbvrq', 'pmd')) ? $val : 0 ?>;
        savedStructure['crit']['cghbvrq']['pass'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cghbvrq', 'pass')) ? $val : 0 ?>;
        
        $('#u_cghbvrq_pmd').val( savedStructure['unit']['cghbvrq']['pmd'] );
        $('#c_cghbvrq_pmd').val( savedStructure['crit']['cghbvrq']['pmd'] );
        $('#c_cghbvrq_pass').val( savedStructure['crit']['cghbvrq']['pass'] );
    }
    
    // CG - Hair & Beauty NVQ
    if (savedStructure['cghbnvq'] > 0)
    {
        
        gt_block_bcgt_switch_qual_structure_mapping('cghbnvq', savedStructure['cghbnvq']);
        
        savedStructure['unit']['cghbnvq'] = [];
        savedStructure['crit']['cghbnvq'] = [];
        
        savedStructure['unit']['cghbnvq']['pass'] = <?= ($val = $oldGT->getMappingNewValue('unit_grading_structure_cghbnvq', 'pass')) ? $val : 0 ?>;
        savedStructure['crit']['cghbnvq']['pass'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_cghbnvq', 'pass')) ? $val : 0 ?>;

        $('#u_cghbnvq_pass').val( savedStructure['unit']['cghbnvq']['pass'] );
        $('#c_cghbnvq_pass').val( savedStructure['crit']['cghbnvq']['pass'] );

    }
    
    if (savedStructure['alvl'] > 0)
    {
        
        gt_block_bcgt_switch_qual_structure_mapping('alvl', savedStructure['alvl']);
        
        savedStructure['crit']['alvl'] = [];
        savedStructure['crit']['alvl']['alevel'] = <?= ($val = $oldGT->getMappingNewValue('crit_grading_structure_alvl', 'alevel')) ? $val : 0 ?>;
        $('#c_alvl_alevel').val( savedStructure['crit']['alvl']['alevel'] );

    }
    
    
    
    
</script>