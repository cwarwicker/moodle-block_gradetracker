<?php if(!defined('BCGT')) exit; ?>

<?php echo (!empty($MSGS['errors'])) ? gt_error_alert_box($MSGS['errors']) : '' ?>
<?php echo (!empty($MSGS['success'])) ? gt_success_alert_box($MSGS['success']) : '' ?>

<?php if ($Qualification->isDeleted()): ?>
    <?php echo gt_info_alert_box( $string['recordisdeleted'] ) ?>
<?php endif; ?>

<div class="gt_full_page">

    <form action="" method="post" id="gt_qual_form">
        <input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />

        <div class='gt_form_panel'>

            <div class='gt_form_panel_heading'>
                <?php echo ($Qualification->isValid()) ? $string['editqualification'] : $string['newqualification'] ?>
            </div>

            <div class='gt_form_panel_body'>

                <p class="gt_c">
                    <input type="submit" class="gt_btn gt_blue" name="save_qualification" value="<?php echo $string['save'] ?>" />
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=quals&section=search" class="gt_btn gt_red"><?php echo $string['cancel'] ?></a>
                </p>

                <?php if ($Qualification->isValid()): ?>
                    <input type="hidden" id="qual_id" name="qual_id" value="<?php echo $Qualification->getID() ?>" />
                <?php endif; ?>

                <div>

                    <table id="gt_qual_form_table">

                        <tr>
                            <td><?php echo $string['qualtype'] ?></td>
                            <td>
                                <select name="qual_type" class="gt_form_control" onchange="this.form.submit();return false;">
                                    <option value=""></option>
                                    <?php if ($structures): ?>
                                        <?php foreach($structures as $struc): ?>
                                            <option value="<?php echo $struc->getID() ?>" <?php echo ($Structure && $Structure->getID() == $struc->getID()) ? 'selected' : ''; ?> ><?php echo $struc->getName() ?></option>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </select>
                            </td>
                        </tr>

                        <?php if ($Structure): ?>

                            <tr>
                                <td><?php echo $string['qualbuilds'] ?></td>
                                <td>
                                     <select name="qual_build" class="gt_form_control gt_load_build_defaults">
                                        <option value=""></option>
                                        <?php if ($builds): ?>
                                            <?php foreach($builds as $build): ?>
                                                <option value="<?php echo $build->getID() ?>" <?php echo ($Qualification->getBuild() && $Qualification->getBuild()->getID() == $build->getID()) ? 'selected' : ''; ?> ><?php echo $build->getName() ?></option>
                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                    </select>
                                    <img src="<?php echo gt_image_url('i/loading_small') ?>" alt="loading" id="gt_build_loading" class="gt_hidden gt_middle" />
                                </td>
                            </tr>

                            <tr>
                                <td><?php echo $string['name'] ?></td>
                                <td>
                                    <input type="text" class="gt_form_control" name="qual_name" value="<?php echo $Qualification->getName() ?>" />
                                </td>
                            </tr>

                            <?php if ($Qualification->getCustomFormElements()): ?>

                                <?php foreach($Qualification->getCustomFormElements() as $element): ?>

                                    <tr>
                                        <td><?php echo $element->getName() ?></td>
                                        <td>
                                            <?php echo $element->display( array('name' => 'custom_elements', 'class' => 'gt_qual_element gt_form_control', 'fancy' => true) ) ?>
                                        </td>
                                    </tr>

                                <?php endforeach; ?>

                            <?php endif; ?>

                        <?php endif; ?>

                    </table>

                </div>

                <?php if ($Structure): ?>

                <br><hr><br>

                <?php if ($Structure->isLevelEnabled("Units")): ?>
                    <div class="gt_page_col">

                        <div class="gt_c">

                            <div class='gt_form_panel_sub_heading'><?php echo $string['unitsonqual'] ?></div>

                            <br><br>

                            <select id="qual_units" class="gt_unit_select" multiple="multiple">
                                <?php if ($Qualification->getUnits()): ?>
                                    <?php foreach($Qualification->getUnits() as $unit): ?>
                                        <option id="qual_unit_opt_<?php echo $unit->getID() ?>" value="<?php echo $unit->getID() ?>" title="<?php echo \addslashes($unit->getDisplayName()) ?>"><?php echo $unit->getOptionName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>

                            <?php if ($Qualification->getUnits()): ?>
                                <?php foreach($Qualification->getUnits() as $unit): ?>
                                    <input type="hidden" id="hidden_qual_unit_<?php echo $unit->getID() ?>" name="qual_units[]" value="<?php echo $unit->getID() ?>" />
                                <?php endforeach; ?>
                            <?php endif; ?>

                            <p>
                                <input id="gt_remove_unit_from_qual_select" type="button" class="gt_btn" value="<?php echo $string['remove'] ?>" />
                                &nbsp;&nbsp;
                                <a href="#" id='gt_qual_units_edit_unit_btn' type="button" class="gt_btn gt_yellow" disabled target="_blank"><?php echo $string['edit'] ?></a>
                            </p>

                        </div>
                        <br>

                        <div class="gt_c">

                            <div class='gt_form_panel_sub_heading'><?php echo $string['unitschoose'] ?></div>

                            <br><br>

                            <div>

                                <select id="gt_filter_units_structure" class="gt_half_width">
                                    <option value=""></option>
                                    <?php if ($structures): ?>
                                        <?php foreach($structures as $struc): ?>
                                        <option value="<?php echo $struc->getID() ?>" <?php echo ($Structure && $Structure->getID() == $struc->getID()) ? 'selected' : '' ?>><?php echo $struc->getName() ?></option>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </select>

                                <select id="gt_filter_units_level" class="gt_half_width">
                                    <option value=""></option>
                                    <?php if ($allLevels): ?>
                                        <?php foreach($allLevels as $level): ?>
                                        <option value="<?php echo $level->getID() ?>"><?php echo $level->getName() ?></option>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </select>

                                <br><br>

                                <input type="text" id="gt_filter_units_name" class="gt_80" placeholder="<?php echo $string['name'] ?>" />
                                <a href="#" class="gt_filter_units">
                                    <img src="<?php echo gt_image_url('i/search') ?>" class="gt_middle" alt="search" />
                                </a>

                                <br>
                                <img src="<?php echo gt_image_url('i/loading_small') ?>" class="gt_hidden" id="gt_filter_units_loading" />

                                <br>
                                <select id="gt_filter_units" class="gt_unit_select" multiple="multiple"></select>

                                <br><br>

                                <p>
                                    <input id="gt_add_units_to_qual_select" type="button" class="gt_btn" value="<?php echo $string['add'] ?>" />
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=units&section=new" class="gt_btn" target="_blank"><?php echo $string['createnew'] ?></a>
                                </p>

                            </div>

                        </div>

                    </div>
                <?php endif; ?>

                <div class="gt_page_col">

                    <div class="gt_c">

                        <div class='gt_form_panel_sub_heading gt_form_panel_sub_heading_alt'><?php echo $string['coursesonqual'] ?></div>

                        <br><br>

                        <select id="qual_courses" class="gt_course_select" multiple="multiple">
                            <?php if ($Qualification->getCourses()): ?>
                                <?php foreach($Qualification->getCourses() as $course): ?>
                                    <option id="qual_course_opt_<?php echo $course->id ?>" value="<?php echo $course->id ?>"><?php echo $course->getName() ?></option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>

                        <?php if ($Qualification->getCourses()): ?>
                            <?php foreach($Qualification->getCourses() as $course): ?>
                            <input type="hidden" id="hidden_qual_course_<?php echo $course->id ?>" name="qual_courses[]" value="<?php echo $course->id ?>" />
                            <?php endforeach; ?>
                        <?php endif; ?>

                        <br>

                        <p>
                            <input id="gt_remove_courses_from_qual_select" type="button" class="gt_btn" value="<?php echo $string['remove'] ?>" />
                            &nbsp;&nbsp;
                            <a href="" id='gt_qual_units_edit_course_btn' type="button" class="gt_btn gt_yellow" disabled target="_blank"><?php echo $string['edit'] ?></a>
                        </p>

                    </div>

                    <br>

                    <div class="gt_c">

                        <div class='gt_form_panel_sub_heading gt_form_panel_sub_heading_alt'><?php echo $string['courseschoose'] ?></div>

                        <br><br>

                        <div>

                            <select id="gt_filter_courses_category" class="gt_half_width">
                                <option value=""></option>
                                <?php if ($allCats): ?>
                                    <?php foreach($allCats as $catID => $catName): ?>
                                        <option value="<?php echo $catID ?>"><?php echo $catName ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>

                            <br><br>

                            <input type="text" id="gt_filter_courses_name" class="gt_80" placeholder="<?php echo $string['searchcourse'] ?>" />
                            <a href="#" class="gt_filter_courses">
                                <img src="<?php echo gt_image_url('i/search') ?>" class="gt_middle" alt="search" />
                            </a>

                            <br>

                            <img src="<?php echo gt_image_url('i/loading_small') ?>" class="gt_hidden" id="gt_filter_courses_loading" />

                            <br>

                            <select id="gt_filter_courses" class="gt_course_select" multiple="multiple">

                            </select>

                            <br><br>

                            <p>
                                <input id="gt_add_courses_to_qual_select" type="button" class="gt_btn" value="<?php echo $string['add'] ?>" />
                                <a href="<?php echo $CFG->wwwroot ?>/course/management.php" target="_blank" class="gt_btn"><?php echo $string['createnew'] ?></a>
                            </p>

                        </div>

                    </div>

                </div>

                <br class="gt_cl"><br>

                <?php endif; ?>

                <p class="gt_c">
                    <input type="submit" class="gt_btn gt_blue" name="save_qualification" value="<?php echo $string['save'] ?>" />
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=quals&section=search" class="gt_btn gt_red"><?php echo $string['cancel'] ?></a>
                </p>

            </div>

        </div>

    </form>

    <?php if ($User->hasCapability('block/gradetracker:delete_restore_quals')): ?>
        <br><br><br><br>
        <p class='gt_c'>
            <?php if ($Qualification->isValid() && !$Qualification->isDeleted()): ?>
                <a href='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=quals&section=delete&id=<?php echo $Qualification->getID() ?>' class='gt_btn gt_red'><?php echo $string['delete'] ?></a>
            <?php elseif ($Qualification->isValid() && $Qualification->isDeleted()): ?>
                <form action='' method='post' class='gt_c'>
                    <input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />
                    <input type='hidden' name='id' value='<?php echo $Qualification->getID() ?>' />
                    <input type='submit' class='gt_btn gt_red' name='restoreQual' value='<?php echo $string['restore'] ?>' />
                </form>
            <?php endif; ?>
        </p>
    <?php endif; ?>

</div>

<br class="gt_cl" />

<script>
    var searchLimit = <?php echo \GT\Course::SEARCH_LIMIT ?>;
</script>