<?php if(!defined('BCGT')) exit; ?>

<form action="" method="post" enctype="multipart/form-data">

    <?php echo (!empty($MSGS['errors'])) ? gt_error_alert_box($MSGS['errors']) : '' ?>
    <?php echo (!empty($MSGS['success'])) ? gt_success_alert_box($MSGS['success']) : '' ?>

    <input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />

    <h2><?php echo $string['reportsettings'] ?></h2>
    <p><?php echo $string['reportsettings:desc'] ?></p>

    <small><strong><?php echo $string['config:reporting:categories'] ?></strong> - <?php echo $string['config:reporting:categories:desc'] ?></small>
    <br>
    <select name='reporting_categories[]' multiple='multiple' style='height:350px;'>
        <?php if ($categories): ?>
            <?php foreach($categories as $catID => $cat): ?>
                <option value="<?php echo $catID ?>" <?php echo (array_key_exists($catID, $reportingCats)) ? 'selected' : '' ?> ><?php echo $cat ?></option>
            <?php endforeach; ?>
        <?php endif; ?>
    </select>
    <br><br>

    <div class="gt_form_panel">
        <div class="gt_form_panel_heading"><?php echo $string['reports:critprog'] ?></div>
        <div class="gt_form_panel_body">
            <p><small><?php echo $string['config:reporting:critscores:desc'] ?></small></p>
            <?php if ($structures): ?>
                <?php foreach($structures as $structure): ?>
                    <?php if ($structure->isAnyCriteriaLevelEnabled()): ?>
                        <table id='gt_crit_prog_wt_<?php echo $structure->getID() ?>' class='gt_report_config_table_narrow'>
                            <tr>
                                <th colspan='3'><?php echo $structure->getName() ?> <a href="#" class="gt_report_add_crit_weighting" structureID="<?php echo $structure->getID() ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/add.png" /></a></th>
                            </tr>
                            <tr>
                                <td><?php echo $string['letter'] ?></td>
                                <td><?php echo $string['score'] ?></td>
                                <td></td>
                            </tr>

                            <?php if( ($rows = json_decode($structure->getSetting('reporting_short_criteria_weighted_scores'))) ): ?>
                                <?php foreach($rows as $row): ?>
                                    <tr>
                                        <td><input type="text" class="gt_text_small" name="crit_weight_scores[<?php echo $structure->getID() ?>][letter][]" value="<?php echo \gt_html($row->letter); ?>" /></td>
                                        <td><input type="text" class="gt_text_small" name="crit_weight_scores[<?php echo $structure->getID() ?>][score][]" value="<?php echo \gt_html($row->score) ?>" /></td>
                                        <td><a href="#" class="gt_remove" remove="parent-row"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png" /></a></td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </table>
                    <?php endif; ?>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>
    </div>
    <br><br>
    <div class="gt_form_panel">
        <div class="gt_form_panel_heading"><?php echo $string['reports:passprog'] ?></div>
        <div class="gt_form_panel_body">
            <p><small><?php echo $string['config:reporting:passprog:desc'] ?></small></p>
            <?php if ($structures): ?>
                <?php foreach($structures as $structure): ?>
                    <?php if ($structure->isAnyCriteriaLevelEnabled()): ?>
                        <table id='gt_pass_prog_<?php echo $structure->getID() ?>' class='gt_report_config_table'>
                            <tr>
                                <th colspan='3'><?php echo $structure->getName() ?></th>
                            </tr>
                            <?php if ($structure->getSetting('custom_dashboard_view') == 'view-criteria-short'): ?>
                                <tr>
                                    <td>
                                        <input type="radio" name="pass_prog_method[<?php echo $structure->getID() ?>]" value="byletter" <?php echo ($structure->getSetting('reporting_pass_criteria_method') == 'byletter') ? 'checked' : '' ?> /> <?php echo $string['reports:passprog:byletter'] ?>
                                    </td>
                                    <td>
                                        <input type="text" name="pass_prog_by_letter[<?php echo $structure->getID() ?>]" value="<?php echo ($structure->getSetting('reporting_pass_criteria_method') == 'byletter') ? \gt_html($structure->getSetting('reporting_pass_criteria_method_value')) : '' ?>" />
                                    </td>
                                </tr>
                            <?php endif; ?>
                            <tr>
                                <td>
                                    <input type="radio" name="pass_prog_method[<?php echo $structure->getID() ?>]" value="bygradestructure" <?php echo ($structure->getSetting('reporting_pass_criteria_method') == 'bygradestructure') ? 'checked' : '' ?>  /> <?php echo $string['reports:passprog:bygradestructure'] ?>
                                </td>
                                <td>
                                    <?php if( ($grading = $structure->getCriteriaGradingStructures(true)) ): ?>
                                        <select name="pass_prog_by_grade_structure[<?php echo $structure->getID() ?>][]" size="<?php echo count($grading) + 1 ?>" multiple>
                                            <option value="" disabled><?php echo $string['pleaseselect'] ?></option>
                                            <?php foreach($grading as $gradeStructure): ?>
                                                <option value="<?php echo $gradeStructure->getID() ?>" <?php echo ($structure->getSetting('reporting_pass_criteria_method') == 'bygradestructure' && in_array($gradeStructure->getID(), explode(",", $structure->getSetting('reporting_pass_criteria_method_value')))) ? 'selected' : '' ?> ><?php echo $gradeStructure->getName() ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    <?php else: ?>
                                        <small><?php echo $string['nogradestructuresdefined'] ?></small>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="radio" name="pass_prog_method[<?php echo $structure->getID() ?>]" value="all" <?php echo ($structure->getSetting('reporting_pass_criteria_method') == 'all') ? 'checked' : '' ?>  /> <?php echo $string['reports:passprog:all'] ?>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="radio" name="pass_prog_method[<?php echo $structure->getID() ?>]" value="disable" <?php echo (!in_array($structure->getSetting('reporting_pass_criteria_method'), array('byletter', 'bygradestructure', 'all'))) ? 'checked' : '' ?>  /> <?php echo $string['disable'] ?>
                                </td>
                            </tr>
                        </table>
                    <?php endif; ?>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>
    </div>

    <br><br>
    <input type="submit" name="submitconfig" class="gt_btn gt_blue"  value="<?php echo $string['save'] ?>" />

</form>