<?php if(!defined('BCGT')) exit; ?>

<?php echo (!empty($MSGS['errors'])) ? gt_error_alert_box($MSGS['errors']) : '' ?>
<?php echo (!empty($MSGS['success'])) ? gt_success_alert_box($MSGS['success']) : '' ?>

<?php if (!$Structure->isEnabled()): ?>
    <?php echo gt_info_alert_box( $string['structureisdisabled'] ) ?>
<?php endif; ?>

<?php $numRuleSets = 0; ?>



<form id="gt_qual_structure_form" action="" method="post" enctype="multipart/form-data">
    <input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />

    <div class='gt_form_panel'>

        <div class='gt_form_panel_heading'>
            <?php echo ($Structure->isValid()) ? $string['breadcrumbs:config:structures:qual:edit'] : $string['breadcrumbs:config:structures:qual:new'] ?>
        </div>

        <div class='gt_form_panel_body'>

            <?php if ($Structure->isValid()): ?>
                <input type="hidden" name="structure_id" value="<?php echo $Structure->getID() ?>" />
            <?php endif; ?>

            <input type="hidden" name="structure_deleted" value="<?php echo (int)$Structure->isDeleted() ?>" />


            <div class='gt_qual_structure'>

                <div class='gt_qual_structure_left'>

                    <div class='gt_structure_name_section'>

                        <label class="gt_input_label"><?php echo $string['name'] ?></label><br>
                        <input type="text" class="" name="structure_name" value="<?php echo $Structure->getName() ?>" placeholder="City & Guilds" />

                        <br><br>

                        <label class="gt_input_label"><?php echo $string['displayname'] ?></label><br>
                        <input type="text" class="" name="structure_display_name" value="<?php echo $Structure->getDisplayName() ?>" placeholder="CG" />

                        <br><br>

                        <label class="gt_input_label"><?php echo $string['enabled'] ?></label><br>
                        <div class="gt_fancy_checkbox">
                            <input id="enabledCheckBox" type="checkbox" class="gt_middle" name="structure_enabled" value="1" <?php echo ($Structure->isEnabled()) ? 'checked' : ''; ?> />
                            <label for="enabledCheckBox"></label>
                        </div>

                        <br><br>

                        <input type="submit" class="gt_btn gt_btn_small gt_blue" name="submit_qual_structure" value="<?php echo $string['save'] ?>">
                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=structures&section=qual" class="gt_btn gt_btn_small gt_red"><?php echo $string['cancel'] ?></a>

                    </div>

                    <br class='gt_cl'><br>

                    <div>

                        <h2><?php echo $string['levels'] ?></h2>

                        <?php if ($possibleLevels): ?>

                            <?php foreach($possibleLevels as $level): ?>

                                <div class='gt_level_box <?php echo ($Structure->isLevelEnabled($level->getID())) ? 'ticked' : ''; ?>'>
                                    <input type='checkbox' name='levels[<?php echo $level->getID() ?>]' value='<?php echo $level->getID() ?>' <?php echo ($Structure->isLevelEnabled($level->getID())) ? 'checked' : ''; ?> />
                                    <img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/tick_round.png" alt="ticked" class="gt_ticked" style="<?php echo ($Structure->isLevelEnabled($level->getID())) ? 'display:inline-block;' : ''; ?>" />
                                    <?php echo $level->getName() ?>
                                    <?php if ( !is_null($level->getMinSubLevels()) && !is_null($level->getMaxSubLevels()) ): ?>
                                        <br>
                                        <small><?php echo $string['maxsubcritlevels'] ?> <input type="number" name="max_sub_crit[<?php echo $level->getID() ?>]" value="<?php echo \gt_html($Structure->getLevelMaxSubCriteria($level->getID())) ?>" min="<?php echo $level->getMinSubLevels() ?>" max="<?php echo $level->getMaxSubLevels() ?>" /></small>
                                    <?php endif; ?>
                                </div>

                            <?php endforeach; ?>

                        <?php else: ?>

                            <?php echo $string['nodata'] ?>

                        <?php endif; ?>





                        <br class='gt_cl'><br>

                        <h2><?php echo $string['features'] ?></h2>

                        <?php if ($possibleFeatures): ?>

                            <?php foreach($possibleFeatures as $feature): ?>

                                <div class='gt_feature_box <?php echo ($Structure->isFeatureEnabled($feature->id)) ? 'ticked' : ''; ?>'>
                                    <input type='checkbox' name='features[]' value='<?php echo $feature->id ?>' <?php echo ($Structure->isFeatureEnabled($feature->id)) ? 'checked' : ''; ?> />
                                    <img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/tick_round.png" alt="ticked" class="gt_ticked" style="<?php echo ($Structure->isFeatureEnabled($feature->id)) ? 'display:inline-block;' : ''; ?>" />
                                    <?php echo $string['features:' . \strtolower(\gt_strip_chars_non_alpha($feature->name))]; ?>
                                    <br>
                                    <small><?php echo $string['features:' . \strtolower(\gt_strip_chars_non_alpha($feature->name)) . ':help']; ?></small>
                                </div>

                            <?php endforeach; ?>

                        <?php else: ?>

                            <?php echo $string['nodata'] ?>

                        <?php endif; ?>

                    </div>

                </div>

                <div class='gt_qual_structure_right'>

                    <div class='gt_structure_settings_box'>
                        <h1><?php echo $string['customformfields'] ?></h1>
                        <div>
                            <table id='gt_custom_form_fields'>
                                <tr>
                                    <th><?php echo $string['name'] ?></th>
                                    <th><?php echo $string['form'] ?></th>
                                    <th><?php echo $string['type'] ?></th>
                                    <th><?php echo $string['options'] ?></th>
                                    <th><?php echo $string['req'] ?></th>
                                    <th><a href="#" id="gt_add_structure_form_field"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/add.png" alt="add new" /></a></th>
                                </tr>

                                <?php if ($Structure->getCustomFormElements()): ?>
                                    <?php foreach($Structure->getCustomFormElements() as $element): ?>
                                      <?php $cntCustomFormElements++ ?>
                                        <tr id="gt_custom_form_field_row_<?php echo $cntCustomFormElements ?>" class="gt_custom_form_field_row">
                                            <td>
                                                <input type="hidden" name="custom_form_fields_ids[<?php echo $cntCustomFormElements ?>]" value="<?php echo $element->getID() ?>" />
                                                <input type="text" name="custom_form_fields_names[<?php echo $cntCustomFormElements ?>]" value="<?php echo \gt_html($element->getName()) ?>" />
                                            </td>
                                            <td>
                                                <select name="custom_form_fields_forms[<?php echo $cntCustomFormElements ?>]">
                                                    <option></option>
                                                    <option value="qualification" <?php echo ($element->getForm() == "qualification") ? 'selected' : ''; ?>><?php echo $string['qualification'] ?></option>
                                                    <option value="unit" <?php echo ($element->getForm() == "unit") ? 'selected' : ''; ?>><?php echo $string['unit'] ?></option>
                                                </select>
                                            </td>
                                            <td>
                                                <select class="gt_toggle_structure_form_field_type" num="<?php echo $cntCustomFormElements ?>" name="custom_form_fields_types[<?php echo $cntCustomFormElements ?>]">
                                                    <option></option>
                                                    <option value="TEXT" <?php echo ($element->getType() == "TEXT") ? 'selected' : ''; ?>><?php echo $string['element:text'] ?></option>
                                                    <option value="NUMBER" <?php echo ($element->getType() == "NUMBER") ? 'selected' : ''; ?>><?php echo $string['element:number'] ?></option>
                                                    <option value="TEXTBOX" <?php echo ($element->getType() == "TEXTBOX") ? 'selected' : ''; ?>><?php echo $string['element:textbox'] ?></option>
                                                    <option value="SELECT" <?php echo ($element->getType() == "SELECT") ? 'selected' : ''; ?>><?php echo $string['element:select'] ?></option>
                                                    <option value="CHECKBOX" <?php echo ($element->getType() == "CHECKBOX") ? 'selected' : ''; ?>><?php echo $string['element:checkbox'] ?></option>
                                                </select>
                                            </td>
                                            <td><input type="text" style="<?php echo ($element->getType() != 'SELECT') ? 'display:none;' : ''; ?>" id="custom_form_fields_options_<?php echo $cntCustomFormElements ?>" name="custom_form_fields_options[<?php echo $cntCustomFormElements ?>]" placeholder="option1,option2,option3" value="<?php echo $element->getOptionsString() ?>"></td>
                                            <td><input type="checkbox" name="custom_form_fields_req[<?php echo $cntCustomFormElements ?>]" value="1" <?php echo ($element->hasValidation("REQUIRED")) ? 'checked' : ''; ?>></td>
                                            <td><a href="#" class="gt_remove" remove="#gt_custom_form_field_row_<?php echo $cntCustomFormElements ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png" alt="remove"></a></td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>

                            </table>
                        </div>

                    </div>


                    <div class='gt_structure_settings_box'>
                        <h1><?php echo $string['rules'] ?></h1>
                        <div>
                            <h3><?php echo $string['rulesets'] ?></h3>
                            <table id='gt_structure_rule_sets'>

                                <tr>
                                    <th><a href="#" id="gt_add_structure_rule_set"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/add.png" alt="add new" /></a></th>
                                    <th><?php echo $string['name'] ?></th>
                                    <th><?php echo $string['rules'] ?></th>
                                    <th><?php echo $string['default'] ?></th>
                                    <th><?php echo $string['enabled'] ?></th>
                                </tr>

                                <?php if ($ruleSets = $Structure->getRuleSets()): ?>
                                    <?php foreach($ruleSets as $ruleSet): ?>

                                        <?php $numRuleSets++; ?>

                                        <tr id='gt_rule_set_row_<?php echo $numRuleSets ?>' class='gt_rule_set_row'>
                                            <td></td>
                                            <td><input type='hidden' name='rule_sets[<?php echo $numRuleSets ?>][id]' value='<?php echo $ruleSet->getID() ?>' /><input type='text' id='rule_set_name_<?php echo $numRuleSets ?>' name='rule_sets[<?php echo $numRuleSets ?>][name]' value='<?php echo \gt_html($ruleSet->getName()) ?>' /></td>
                                            <td><a href='#' class='gt_structure_open_rules' ruleSetNum='<?php echo $numRuleSets ?>'><?php echo $string['openrules'] ?> <img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/open.png' alt='open' /></a></td>
                                            <td><input type='radio' name='rule_set_default' value='<?php echo $numRuleSets ?>' <?php echo ($ruleSet->isDefault()) ? 'checked' : '' ?> /></td>
                                            <td><input type='checkbox' name='rule_sets[<?php echo $numRuleSets ?>][enabled]' value='1' <?php echo ($ruleSet->isEnabled()) ? 'checked' : '' ?> /></td>
                                            <td><a href='#' class='gt_remove_structure_rule_set' ruleSetNum='<?php echo $numRuleSets ?>'><img src='<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/remove.png' alt='delete' /></a></td>
                                        </tr>

                                    <?php endforeach; ?>
                                <?php endif; ?>


                            </table>

                        </div>

                    </div>


                    <div class='gt_structure_settings_box'>
                        <h1><?php echo $string['settings'] ?></h1>
                        <div>
                            <table id="gt_structure_misc">
                                <tr>
                                    <th><?php echo $string['setting'] ?></th>
                                    <th><?php echo $string['value'] ?></th>
                                </tr>
                                <tr>
                                    <td><?php echo $string['displayname'] ?></td>
                                    <td>
                                        <input type="text" name="settings[custom_displayname]" placeholder="<?php echo $string['default:displayname'] ?>" value="<?php echo \gt_html($Structure->getSetting('custom_displayname')) ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['setting:criteriaordering'] ?></td>
                                    <td>
                                        <input type="text" name="settings[custom_order_criteria]" placeholder="<?php echo $string['order:placeholder'] ?>" value="<?php echo \gt_html($Structure->getCustomOrder('criteria')) ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['setting:unitordering'] ?></td>
                                    <td>
                                        <input type="text" name="settings[custom_order_units]" placeholder="<?php echo $string['order:placeholder'] ?>" value="<?php echo \gt_html($Structure->getCustomOrder('units')) ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['setting:ivcolumn'] ?></td>
                                    <td>
                                        <input type="checkbox" name="settings[iv_column]" value="1" <?php echo ( $Structure->getSetting('iv_column') == 1 ) ? 'checked' : '' ?> />
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['dashboard:griddisplay'] ?></td>
                                    <td>
                                        <input type="radio" name="settings[custom_dashboard_view]" value="view-simple" <?php if ($Structure->getSetting('custom_dashboard_view') == 'view-simple'): ?> checked <?php endif; ?>> <?php echo $string['dashboard:display:simple'] ?><br>
                                        <input type="radio" name="settings[custom_dashboard_view]" value="view-criteria-short" <?php if ($Structure->getSetting('custom_dashboard_view') == 'view-criteria-short'): ?> checked <?php endif; ?>> <?php echo $string['dashboard:display:short'] ?><br>
                                        <input type="radio" name="settings[custom_dashboard_view]" value="view-criteria-full" <?php if ($Structure->getSetting('custom_dashboard_view') == 'view-criteria-full'): ?> checked <?php endif; ?>> <?php echo $string['dashboard:display:full'] ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['setting:forcesinglepage'] ?></td>
                                    <td>
                                        <input type="checkbox" name="settings[force_single_page]" value="1" <?php echo ( $Structure->getSetting('force_single_page') == 1 ) ? 'checked' : '' ?> />
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo $string['setting:critletters'] ?></td>
                                    <td>
                                        <input type="text" name="settings[criteria_letters]" value="<?php echo \gt_html($Structure->getSetting('criteria_letters')) ?>" placeholder="e.g. P,M,D" />
                                    </td>
                                </tr>
                                <!-- IF YOU ADD A NEW SETTING, REMEMBER TO ADD IT TO QUAL STRUCTURE EXPORT/IMPORT -->
                            </table>
                        </div>
                    </div>

                </div>

                <br class='gt_cl'><br>

            </div>

        </div>

    </div>

    <?php $numRulesArray = array() ?>
    <?php $numRuleSteps = array() ?>

    <?php if ($ruleSets): ?>

        <?php foreach($ruleSets as $ruleSet): ?>

            <?php $ruleSetNum = (isset($ruleSetNum)) ? $ruleSetNum + 1 : 1; ?>
            <?php $numRulesArray[$ruleSetNum] = 0; ?>
            <?php $numRuleSteps[$ruleSetNum] = array() ?>

            <?php include $CFG->dirroot . '/blocks/gradetracker/tpl/config/structures/qual/inc/ruleset.inc.html'; ?>

        <?php endforeach; ?>
    <?php endif; ?>

</form>


<!-- Templates -->
<?php unset($rule) ?>
<?php include $CFG->dirroot . '/blocks/gradetracker/tpl/config/structures/qual/inc/rulestep.inc.html'; ?>
<?php include $CFG->dirroot . '/blocks/gradetracker/tpl/config/structures/qual/inc/rulestepcondition.inc.html'; ?>
<?php include $CFG->dirroot . '/blocks/gradetracker/tpl/config/structures/qual/inc/rulestepaction.inc.html'; ?>
<!-- End Templates -->