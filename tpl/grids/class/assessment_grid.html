<?php if(!defined('BCGT')) exit; ?>

<table id="gt_class_grid" class="gt_class_assessment_grid" style="width:95%;">

  <thead>
    <tr>

        <th colspan='<?php echo $weightingColspan ?>' class='gt_grid_freeze_col'><?php echo $string['overall'] ?></th>

        <?php if ($Qualification->getAssessments()): ?>

            <?php foreach($Qualification->getAssessments() as $assessment): ?>

                 <!-- Custom Fields -->
                <?php if (array_key_exists($assessment->getID(), $customFieldsArray) && $customFieldsArray[$assessment->getID()]): ?>
                    <?php foreach($customFieldsArray[$assessment->getID()] as $field): ?>
                        <th></th>
                    <?php endforeach; ?>
                <?php endif; ?>

                <?php if ($assessment->getSetting('grading_method') != 'none'): ?>
                    <?php if($percentile = $Qualification->getClassAssessmentWeightingPercentile($assessment, $students)): ?>
                        <th class="gt_percentile" style="background-color:<?php echo (\GT\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;">
                            <?php echo $percentile->percentile ?>
                        </th>
                    <?php else: ?>
                        <th></th>
                    <?php endif; ?>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('cetagrades') && $assessment->isCetaEnabled()): ?>
                    <?php if($percentile = $Qualification->getClassAssessmentCetaWeightingPercentile($assessment, $students)): ?>
                        <th class="gt_percentile" style="background-color:<?php echo (\GT\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;">
                            <?php echo $percentile->percentile ?>
                        </th>
                    <?php else: ?>
                        <th></th>
                    <?php endif; ?>
                <?php endif; ?>

                <?php if (!isset($print) && $GT->getSetting('use_assessments_comments') == 1): ?>
                    <th></th>
                <?php endif; ?>

            <?php endforeach; ?>

        <?php endif; ?>

    </tr>


    <tr>

        <?php if ($studentCols): ?>
            <?php foreach($studentCols as $col): ?>
                <th rowspan='2' class="gt_grid_user_<?php echo $col ?>"><?php echo ($col != 'pic') ? get_string($col) : '' ?></th>
            <?php endforeach; ?>
        <?php endif; ?>

        <?php if ($Qualification->isFeatureEnabledByName('targetgrades')): ?>
            <th rowspan='2'><?php echo $string['target'] ?></th>
        <?php endif; ?>

        <?php if ($Qualification->isFeatureEnabledByName('weightedtargetgrades')): ?>
            <th rowspan='2'><?php echo $string['weightedtarget'] ?></th>
        <?php endif; ?>

        <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
            <th rowspan='2'><?php echo $string['ceta'] ?></th>
        <?php endif; ?>

         <!-- ALPS -->
        <?php if ($canSeeWeightings): ?>
            <th rowspan='2'>
                <?php if (!isset($print)): ?>
                    <a href="#" class="gt_toggle" toggle=".gt_assessment_grade_ceta_cell, .gt_hidden_percentile_cell"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/scales.png" alt="<?php echo $string['weighting'] ?>" onmouseover="$(this).attr('src', '<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/scales_black.png');" onmouseout="$(this).attr('src', '<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/scales.png');" /></a>
                    <br><br>
                <?php endif; ?>
                <?php echo $string['weighting'] ?>
            </th>
        <?php endif; ?>

        <?php if ($Qualification->getAssessments()): ?>
            <?php foreach($Qualification->getAssessments() as $assessment): ?>
                <th colspan='<?php echo (array_key_exists($assessment->getID(), $colspanArray)) ? $colspanArray[$assessment->getID()] : $defaultColspan ?>'>
                    <?php echo $assessment->getName() ?>
                    <br>
                    <small><?php echo $assessment->getDate('d-m-Y') ?></small>
                </th>
            <?php endforeach; ?>
        <?php endif; ?>



    </tr>


    <tr>

        <?php if ($Qualification->getAssessments()): ?>

            <?php foreach($Qualification->getAssessments() as $assessment): ?>

                 <!-- Custom Fields -->
                <?php if (array_key_exists($assessment->getID(), $customFieldsArray) && $customFieldsArray[$assessment->getID()]): ?>
                    <?php foreach($customFieldsArray[$assessment->getID()] as $field): ?>
                        <th><?php echo $field->getName() ?></th>
                    <?php endforeach; ?>
                <?php endif; ?>

                <?php if ($assessment->getSetting('grading_method') != 'none'): ?>
                    <th><?php echo $string['grade'] ?></th>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('cetagrades') && $assessment->isCetaEnabled()): ?>
                    <th><?php echo $string['ceta'] ?></th>
                <?php endif; ?>

                <?php if (!isset($print) && $GT->getSetting('use_assessments_comments') == 1): ?>
                    <th><?php echo $string['comments'] ?></th>
                <?php endif; ?>

            <?php endforeach; ?>

        <?php endif; ?>

    </tr>
  </thead>

  <tbody>
     <?php if ($students): ?>

        <?php foreach($students as $student): ?>

            <?php $Qualification->loadStudent($student) ?>

            <tr>

                <?php if ($studentCols): ?>

                    <?php foreach($studentCols as $col): ?>

                        <td>
                            <?php if( \gt_has_capability('block/gradetracker:view_student_grids') && !isset($print) ): ?>
                                <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=student&id=<?php echo $student->id ?>&qualID=<?php echo $Qualification->getID() ?>&access=<?php echo $params['access'] ?>" target="_blank"><?php echo $student->getProp($col) ?></a>
                            <?php else: ?>
                                <?php echo $student->getProp($col) ?>
                            <?php endif; ?>
                        </td>

                    <?php endforeach; ?>

                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('targetgrades')): ?>
                    <td id="gt_user_target_grade_<?php echo $student->id ?>_<?php echo $Qualification->getID() ?>" class='gt_assessment_grade_cell'>
                        <span><?php echo $student->getUserGrade('target', array('qualID' => $Qualification->getID()), false, false, '-') ?><span>
                    </td>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('weightedtargetgrades')): ?>
                    <td id="gt_user_weighted_target_grade_<?php echo $student->id ?>_<?php echo $Qualification->getID() ?>" class='gt_assessment_grade_cell'>
                        <span><?php echo $student->getUserGrade('weighted_target', array('qualID' => $Qualification->getID()), false, false, '-') ?></span>
                    </td>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
                    <td class='gt_assessment_grade_cell'>
                        <?php $latestCetaGrade = $Qualification->getUserLatestAssessmentCetaWithAward(); ?>
                        <?php echo ($latestCetaGrade) ? $latestCetaGrade->getName() : '-' ?>
                    </td>
                <?php endif; ?>

                <?php if ($canSeeWeightings): ?>
                    <td>-</td>
                <?php endif; ?>


                <?php if ($Qualification->getAssessments()): ?>

                    <?php foreach($Qualification->getAssessments() as $assessment): ?>

                        <!-- Custom Fields -->
                        <?php if (array_key_exists($assessment->getID(), $customFieldsArray) && $customFieldsArray[$assessment->getID()]): ?>
                            <?php foreach($customFieldsArray[$assessment->getID()] as $field): ?>
                                <td class='gt_assessment_grid_cell_<?php echo $params['access'] ?>' qID='<?php echo $Qualification->getID() ?>' sID='<?php echo $student->id ?>' aID='<?php echo $assessment->getID() ?>' type='custom_field' fID='<?php echo $field->getID() ?>' aName='<?php echo \gt_html($Qualification->getDisplayName() . " - " . $assessment->getName()) ?>' title='<?php echo \gt_html($Qualification->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                    <?php echo $assessment->getCustomFieldCell($field, $params['access'], $student) ?>
                                </td>
                            <?php endforeach; ?>
                        <?php endif; ?>

                        <?php if ($assessment->getSetting('grading_method') != 'none'): ?>
                            <td class='gt_assessment_grade_ceta_cell gt_grid_cell gt_assessment_grid_cell_<?php echo $params['access'] ?>' qID='<?php echo $Qualification->getID() ?>' sID='<?php echo $student->id ?>' aID='<?php echo $assessment->getID() ?>' type='grade' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                <?php echo $assessment->getGradeCell($params['access'], $student) ?>
                                <div id='pU_<?php echo $student->id ?>_<?php echo $Qualification->getID() ?>_<?php echo $assessment->getID() ?>' class='gt_popup' title='<?php echo \gt_html($assessment->getName()) ?>'></div>
                            </td>
                        <?php endif; ?>

                        <!-- Weighting cell -->
                        <?php if ($canSeeWeightings): ?>

                            <?php if($percentile = $Qualification->getUserAssessmentWeightingPercentile($assessment)): ?>
                                <td class="gt_percentile gt_hidden_percentile_cell" style="display:none;background-color:<?php echo (\GT\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;" title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                    <?php echo $percentile->percentile ?>
                                </td>
                            <?php else: ?>
                                <td class='gt_hidden_percentile_cell' style='display:none;' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                    <?php echo $assessment->getGradeCell('v', $student) ?>
                                </td>
                            <?php endif; ?>

                        <?php else: ?>

                            <td class="gt_hidden_percentile_cell gt_cell_blank" style='display:none;' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'></td>

                        <?php endif; ?>



                        <?php if ($Qualification->isFeatureEnabledByName('cetagrades') && $assessment->isCetaEnabled()): ?>


                            <td class='gt_assessment_grade_ceta_cell gt_grid_cell gt_assessment_grid_cell_<?php echo $params['access'] ?>' qID='<?php echo $Qualification->getID() ?>' sID='<?php echo $student->id ?>' aID='<?php echo $assessment->getID() ?>' type='ceta' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                <?php echo $assessment->getCetaCell($params['access'], $student) ?>
                            </td>


                            <!-- Weighting cell -->
                            <?php if ($canSeeWeightings): ?>
                                <?php if($percentile = $Qualification->getUserAssessmentCetaWeightingPercentile($assessment)): ?>
                                    <td class="gt_percentile gt_hidden_percentile_cell" style="display:none;background-color:<?php echo (\GT\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;" title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                        <?php echo $percentile->percentile ?>
                                    </td>
                                <?php else: ?>
                                    <td class='gt_hidden_percentile_cell' style='display:none;' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                        <?php echo $assessment->getCetaCell('v', $student) ?>
                                    </td>
                                <?php endif; ?>
                            <?php else: ?>
                                    <td class="gt_hidden_percentile_cell gt_cell_blank" style='display:none;' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'></td>
                            <?php endif; ?>


                        <?php endif; ?>


                        <?php if (!isset($print) && $GT->getSetting('use_assessments_comments') == 1): ?>
                            <td qID='<?php echo $Qualification->getID() ?>' sID='<?php echo $student->id ?>' aID='<?php echo $assessment->getID() ?>' qName='<?php echo \gt_html($Qualification->getName()); ?>' aName='<?php echo \gt_html($assessment->getName()); ?>' class='<?php echo ($assessment->hasUserComments()) ? "gt_has_comments" : "" ?> gt_assessment_grid_cell_<?php echo $params['access'] ?>' title='<?php echo \gt_html($student->getDisplayName() . " - " . $assessment->getName()) ?>'>
                                <?php echo $assessment->getCommentsCell($params['access'], $student); ?>
                            </td>
                        <?php endif; ?>


                    <?php endforeach; ?>

                <?php endif; ?>

            </tr>

        <?php endforeach; ?>

    <?php endif; ?>
  </tbody>

</table>