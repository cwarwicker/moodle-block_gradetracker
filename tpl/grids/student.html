<?php if(!defined('BCGT')) exit; ?>

<input type="hidden" id="gt-gridFile" value="<?php echo $gridFile ?>" />
<input type="hidden" id="gt-qID" value="<?php echo $Qualification->getID() ?>" />
<input type="hidden" id="gt-sID" value="<?php echo $Student->id ?>" />
<input type="hidden" id="gt-access" value="<?php echo $access ?>" />
<input type="hidden" id="gt-assessmentView" value="<?php echo $assessmentView ?>" />

<div class='gt_full_page gt_grid'>

    <div class="gt_c">

        <?php if (!isset($print)): ?>

            <?php if (!isset($external) || !$external): ?>

                <div class="gt_dropdown_menu">
                    <a href="#" class="gt_dropdown_toggle">
                        <img src="<?php echo $GT->icon('cog') ?>" class="gt_icon" />
                    </a>
                    <ul class="gt_dropdown_menu">

                        <li class="gt_c"><b><?php echo $string['actions'] ?></b></li>

                        <?php if ($Qualification->isFeatureEnabledByName('targetgrades')): ?>
                            <li>
                                <a href="#" class="gt_refresh_grid_grade" type="gcse"><?php echo $string['refreshgcsescore'] ?> <span id="gt_refresh_gcse_loader" style="display:none;"><img src="<?php echo gt_image_url('i/loading_small') ?>" alt="loading" /></span></a>
                            </li>
                            <li>
                                <a href="#" class="gt_refresh_grid_grade" type="tg"><?php echo $string['refreshtargetgrade'] ?> <span id="gt_refresh_tg_loader" style="display:none;"><img src="<?php echo gt_image_url('i/loading_small') ?>" alt="loading" /></span></a>
                            </li>
                        <?php endif; ?>

                        <?php if ($Qualification->isFeatureEnabledByName('weightedtargetgrades')): ?>
                            <li>
                                <a href="#" class="gt_refresh_grid_grade" type="wtg"><?php echo $string['refreshweightedtargetgrade'] ?> <span id="gt_refresh_wtg_loader" style="display:none;"><img src="<?php echo gt_image_url('i/loading_small') ?>" alt="loading" /></span></a>
                            </li>
                        <?php endif; ?>

                        <?php if ($Qualification->isFeatureEnabledByName('predictedgrades') || $Qualification->isFeatureEnabledByName('predictedminmaxgrades')): ?>
                            <li>
                                <a href="#" class="gt_refresh_grid_grade" type="pg"><?php echo $string['refreshpredictedgrades'] ?> <span id="gt_refresh_pg_loader" style="display:none;"><img src="<?php echo gt_image_url('i/loading_small') ?>" alt="loading" /></span></a>
                            </li>
                        <?php endif; ?>

                    </ul>
                </div>

                <br class="gt_cl">

                <ul class="slimmenu">

                    <?php if (\gt_has_capability('block/gradetracker:view_student_grids')): ?>

                        <li class="gt_nav_dropdowns">
                            <select class="gt_switch_qual">
                                <option value=""><?php echo $string['switchqual'] ?></option>
                                <?php if($Student->getQualifications("STUDENT")): ?>
                                    <?php foreach($Student->getQualifications("STUDENT") as $userQual): ?>
                                        <option value="<?php echo $userQual->getID() ?>" <?php echo ($userQual->getID() == $Qualification->getID()) ? 'selected' : ''; ?> ><?php echo $userQual->getDisplayName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>

                            <select class="gt_switch_user">
                                <option value=""><?php echo $string['switchuser'] ?></option>
                                <?php if ($Qualification->getUsers("STUDENT")): ?>
                                    <?php foreach($Qualification->getUsers("STUDENT") as $qualStudent): ?>
                                        <option value="<?php echo $qualStudent->id ?>" <?php echo ($qualStudent->id == $Student->id) ? 'selected' : ''; ?> ><?php echo $qualStudent->getDisplayName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                        </li>

                    <?php endif; ?>

                    <li>

                        <a href="#"><?php echo $string['grid'] ?></a>
                        <ul>

                            <li>
                                <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/print.php?type=student&id=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?>&courseID=<?php echo $courseID ?><?php echo (isset($assessmentView) && $assessmentView) ? '&ass=1' : ''; ?>"><?php echo $string['printgrid'] ?></a>
                            </li>

                            <?php if (\gt_has_capability('block/gradetracker:export_student_grids') || $User->id == $Student->id): ?>
                                <li>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/export.php?type=datasheet&grid=student&studentID=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?><?php echo (isset($assessmentView) && $assessmentView) ? '&ass=1' : '' ?>&sesskey=<?php echo sesskey() ?>"><?php echo $string['exportdatasheet'] ?></a>
                                </li>
                            <?php endif; ?>

                            <?php if (\gt_has_capability('block/gradetracker:import_student_grids')): ?>
                                <li>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/import.php?type=datasheet&grid=student&studentID=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?><?php echo (isset($assessmentView) && $assessmentView) ? '&ass=1' : '' ?>"><?php echo $string['importdatasheet'] ?></a>
                                </li>
                            <?php endif; ?>

                        </ul>

                    </li>

                    <li>
                        <a href="#"><?php echo $string['context'] ?></a>
                        <ul>
                            <li>
                                <a href="<?php echo $CFG->wwwroot ?>/user/profile.php?id=<?php echo $Student->id ?>"><?php echo $string['userprofile'] ?></a>
                            </li>

                            <?php if (\gt_is_plugin_installed('block_elbp')): ?>
                                <li>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/elbp/view.php?id=<?php echo $Student->id ?>"><?php echo get_string('viewelbp', 'block_elbp') ?></a>
                                </li>
                            <?php endif; ?>

                            <?php if ( $courseID > 0 && ($User->isOnCourse($courseID, "STAFF") || $User->hasCapability('block/gradetracker:edit_all_courses')) ): ?>
                                <li>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&section=userquals&id=<?php echo $courseID ?>"><?php echo $string['userquals'] ?></a>
                                </li>
                                <li>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=course&section=userunits&id=<?php echo $courseID ?>"><?php echo $string['userunits'] ?></a>
                                </li>
                            <?php endif; ?>
                        </ul>
                    </li>

                    <li>
                        <a href="#"><?php echo $string['core'] ?></a>
                        <ul>
                            <li>
                                <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/dashboard.php"><?php echo $string['mydashboard'] ?></a>
                            </li>

                            <?php if ($User->hasCapability('block/gradetracker:view_student_grids')): ?>
                                <li>
                                    <?php if ($courseID > 0): ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=student&myCourseID=<?php echo $courseID ?>"><?php echo $string['studentgrids'] ?></a>
                                    <?php else: ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=student"><?php echo $string['studentgrids'] ?></a>
                                    <?php endif; ?>
                                </li>
                            <?php endif; ?>

                            <?php if ($User->hasCapability('block/gradetracker:view_unit_grids')): ?>
                                <li>
                                    <?php if ($courseID > 0): ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=unit&myCourseID=<?php echo $courseID ?>"><?php echo $string['unitgrids'] ?></a>
                                    <?php else: ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=unit"><?php echo $string['unitgrids'] ?></a>
                                    <?php endif; ?>
                                </li>
                            <?php endif; ?>

                            <?php if ($User->hasCapability('block/gradetracker:view_class_grids')): ?>
                                <li>
                                    <?php if ($courseID > 0): ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=class&myCourseID=<?php echo $courseID ?>"><?php echo $string['classgrids'] ?></a>
                                    <?php else: ?>
                                        <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/choose.php?type=class"><?php echo $string['classgrids'] ?></a>
                                    <?php endif; ?>
                                </li>
                            <?php endif; ?>

                        </ul>
                    </li>

                    <?php if ($links): ?>

                        <?php foreach($links as $link): ?>

                        <li>
                            <a href="<?php echo (strlen($link->url)) ? $Qualification->parseURL($link->url) : '#' ?>" target="_blank"><?php echo \gt_html($link->name) ?></a>
                            <?php if ($link->sub): ?>
                            <ul>
                                <?php foreach($link->sub as $sub): ?>
                                    <li>
                                        <a href="<?php echo (strlen($sub->url)) ? $Qualification->parseURL($sub->url) : '#' ?>" target="_blank"><?php echo \gt_html($sub->name) ?></a>
                                    </li>
                                <?php endforeach; ?>
                            </ul>
                            <?php endif; ?>
                        </li>

                        <?php endforeach; ?>

                    <?php endif; ?>

                </ul>

            <br>

            <?php endif; ?>
        <?php endif; ?>



        <?php if (isset($print)): ?>
            <h2><?php echo $Qualification->getDisplayName() ?></h2>
            <h3><?php echo $Student->getDisplayName() ?></h3>
        <?php else: ?>
            <h2 class="gt_h2">
                <?php echo $Student->getPicture(null, 80) ?>
                <br>
                <?php echo $Student->getDisplayName() ?>
                <br>
                <?php if ($User->hasCapability('block/gradetracker:view_class_grids')): ?>
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=class&id=<?php echo $Qualification->getID() ?>&courseID=<?php echo $courseID ?>"><?php echo $Qualification->getDisplayName() ?></a>
                <?php else: ?>
                    <?php echo $Qualification->getDisplayName() ?>
                <?php endif; ?>
            </h2>
        <?php endif; ?>

        <br>

        <?php if ((!isset($print) || !$print) && $assessmentView && $hasWeightings && \gt_has_capability('block/gradetracker:see_coefficient_table') && $QualStructure->getSetting('force_single_page') != 1): ?>

            <table class='gt_coefficient_table' cellspacing='0'>
                <tr>
                    <th colspan="<?php echo $weightingPercentiles + 2 ?>"><?php echo $string['weightingcoefficients'] ?></th>
                </tr>
                <tr>
                    <th><?php echo $string['qualification'] ?></th>
                    <?php for ($i = 1; $i <= $weightingPercentiles; $i++): ?>
                        <th style="background-color:<?php echo \block_gradetracker\Setting::getSetting('weighting_percentile_color_'.$i) ?>;"><?php echo $i ?></th>
                    <?php endfor; ?>
                </tr>
                <?php foreach($allQualifications as $qual): ?>
                    <?php if ($qual->getAssessments() && $qual->getStructure()->getSetting('force_single_page') != 1): ?>
                        <tr>
                            <td class='gt_qual_name'><?php echo $qual->getDisplayName() ?></td>
                            <?php for ($i = 1; $i <= $weightingPercentiles; $i++): ?>
                                <td style="background-color:<?php echo \block_gradetracker\Setting::getSetting('weighting_percentile_color_'.$i) ?>;"><?php echo $qual->getAttribute('coefficient_'.$i) ?></td>
                            <?php endfor; ?>
                        </tr>
                    <?php endif; ?>
                <?php endforeach; ?>
            </table>
            <br>

        <?php endif; ?>





        <?php if ($assessmentView && \gt_has_capability('block/gradetracker:see_assessment_summary_table') && $QualStructure->getSetting('force_single_page') != 1): ?>

            <table class="gt_assessment_summary_table" cellspacing='0'>

                <tr>

                    <th rowspan="<?php echo ($canSeeValueAdded) ? 3 : 2 ?>"><?php echo $string['qualification'] ?></th>

                    <!-- If user has "both" permission, they can see Target and Weighted target -->
                    <!-- Otherwise, Weighted Target takes precedence  -->

                    <?php if ($canSeeBothTargets || ( $canSeeTargetGrade && !$canSeeWeightedTargetGrade ) ): ?>
                        <th rowspan='<?php echo ($canSeeValueAdded) ? 3 : 2 ?>'><?php echo $string['targetgrade'] ?></th>
                    <?php endif; ?>

                    <?php if ($canSeeBothTargets || $canSeeWeightedTargetGrade ): ?>
                        <th rowspan='<?php echo ($canSeeValueAdded) ? 3 : 2 ?>'><?php echo $string['weightedtargetgrade'] ?></th>
                    <?php endif; ?>

                    <th colspan="<?php echo ($canSeeValueAdded) ? ( ($canSeeBothTargets) ? 3 : 2 ) : 1 ?>"><?php echo $string['grade'] ?></th>

                    <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
                        <th colspan="<?php echo ($canSeeValueAdded) ? ( ($canSeeBothTargets) ? 3 : 2 ) : 1 ?>"><?php echo $string['ceta'] ?></th>
                    <?php endif; ?>

                    <?php if ($hasWeightings && \gt_has_capability('block/gradetracker:see_weighting_percentiles')): ?>
                        <th colspan="<?php echo ($Qualification->isFeatureEnabledByName('cetagrades')) ? 2 : 1 ?>"><?php echo $string['weighting'] ?></th>
                    <?php endif; ?>

                </tr>

                <tr>

                    <!-- Current and VA columns for the Assessments column -->
                    <th rowspan="<?php echo ($canSeeValueAdded) ? 2 : 1 ?>"><?php echo $string['latest'] ?></th>

                    <?php if ($canSeeValueAdded): ?>
                        <th colspan="<?php echo ( $canSeeBothTargets ) ? 2 : 1 ?>"><?php echo $string['valueadded:acronym'] ?></th>
                    <?php endif; ?>


                    <!-- Current and VA columns for the CETA column -->
                    <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
                        <th rowspan="<?php echo ($canSeeValueAdded) ? 2 : 1 ?>"><?php echo $string['latest'] ?></th>
                        <?php if ($canSeeValueAdded): ?>
                            <th colspan="<?php echo ( $canSeeBothTargets ) ? 2 : 1 ?>"><?php echo $string['valueadded:acronym'] ?></th>
                        <?php endif; ?>
                    <?php endif; ?>

                    <!-- Weightings columns -->
                    <?php if ($hasWeightings && \gt_has_capability('block/gradetracker:see_weighting_percentiles')): ?>
                        <th rowspan="<?php echo ($canSeeValueAdded) ? 2 : 1 ?>"><?php echo $string['assessments:acronym'] ?></th>
                        <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
                            <th rowspan="<?php echo ($canSeeValueAdded) ? 2 : 1 ?>"><?php echo $string['ceta'] ?></th>
                        <?php endif; ?>
                    <?php endif; ?>

                </tr>



                <?php if ($canSeeValueAdded): ?>

                    <tr>

                        <!-- Assessments columns -->
                        <?php if ($canSeeBothTargets || ( $canSeeTargetGrade && !$canSeeWeightedTargetGrade ) ): ?>
                            <th><?php echo $string['target:acronym'] ?></th>
                        <?php endif; ?>

                        <?php if ($canSeeBothTargets || $canSeeWeightedTargetGrade ): ?>
                            <th><?php echo $string['weightedtarget:acronym'] ?></th>
                        <?php endif; ?>


                        <!-- CETA columns -->
                        <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>
                            <?php if ($canSeeBothTargets || ( $canSeeTargetGrade && !$canSeeWeightedTargetGrade ) ): ?>
                                <th><?php echo $string['target:acronym'] ?></th>
                            <?php endif; ?>

                            <?php if ($canSeeBothTargets || $canSeeWeightedTargetGrade ): ?>
                                <th><?php echo $string['weightedtarget:acronym'] ?></th>
                            <?php endif; ?>
                        <?php endif; ?>

                    </tr>

                <?php endif; ?>


                <?php if (isset($allQualifications) && $allQualifications): ?>

                    <?php foreach($allQualifications as $qual): ?>

                        <?php if ($qual->getAssessments() && $qual->getStructure()->getSetting('force_single_page') != 1): ?>

                            <tr>

                                <td class='gt_qual_name'><?php echo $qual->getDisplayName() ?></td>

                                <?php if (\gt_has_capability('block/gradetracker:see_both_target_weighted_target_grades') || ( \gt_has_capability('block/gradetracker:see_target_grade') && !\gt_has_capability('block/gradetracker:see_weighted_target_grade') ) ): ?>
                                    <td>
                                        <?php echo $Student->getUserGrade('target', array('qualID' => $qual->getID()), false, false, '-') ?>
                                    </td>
                                <?php endif; ?>

                                <?php if (\gt_has_capability('block/gradetracker:see_both_target_weighted_target_grades') || ( \gt_has_capability('block/gradetracker:see_weighted_target_grade') ) ): ?>
                                    <td>
                                        <?php echo $Student->getUserGrade('weighted_target', array('qualID' => $qual->getID()), false, false, '-') ?>
                                    </td>
                                <?php endif; ?>





                                <td>
                                    <?php if ($latestAssessmentWithGrade = $qual->getUserLatestAssessment('summary', true)): ?>
                                        <span title="<?php echo $latestAssessmentWithGrade->getName() ?>"><?php echo $latestAssessmentWithGrade->getGradeCell('v') ?></span>
                                    <?php endif; ?>
                                </td>

                                <?php if ($canSeeValueAdded): ?>

                                    <?php if ($canSeeBothTargets || ( $canSeeTargetGrade && !$canSeeWeightedTargetGrade ) ): ?>
                                        <td>
                                            <?php echo $qual->getValueAddedComparison( $qual->getUserLatestAssessmentGradeWithAward('summary'), $Student->getUserGrade('target', array('qualID' => $qual->getID()), false, true), 'grade', '-' ) ?>
                                        </td>
                                    <?php endif; ?>

                                    <?php if ($canSeeBothTargets || $canSeeWeightedTargetGrade ): ?>
                                        <td>
                                            <?php echo $qual->getValueAddedComparison( $qual->getUserLatestAssessmentGradeWithAward('summary'), $Student->getUserGrade('weighted_target', array('qualID' => $qual->getID()), false, true), 'grade', '-' ) ?>
                                        </td>
                                    <?php endif; ?>

                                <?php endif; ?>







                                <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>

                                    <td>
                                        <?php if ($qual->isFeatureEnabledByName('cetagrades') && ($latestAssessmentWithCetaGrade = $qual->getUserLatestAssessment('summary', false, true))): ?>
                                            <span title="<?php echo $latestAssessmentWithCetaGrade->getName() ?>"><?php echo $latestAssessmentWithCetaGrade->getCetaCell('v') ?></span>
                                        <?php else: ?>
                                            -
                                        <?php endif; ?>
                                    </td>

                                    <?php if ($canSeeBothTargets || ( $canSeeTargetGrade && !$canSeeWeightedTargetGrade ) ): ?>
                                        <td>
                                            <?php if ($qual->isFeatureEnabledByName('cetagrades')): ?>
                                                <?php echo $qual->getValueAddedComparison( $qual->getUserLatestAssessmentCetaWithAward('summary'), $Student->getUserGrade('target', array('qualID' => $qual->getID()), false, true), 'ceta' ) ?>
                                            <?php else: ?>
                                            -
                                            <?php endif; ?>
                                        </td>
                                    <?php endif; ?>

                                    <?php if ($canSeeBothTargets || $canSeeWeightedTargetGrade ): ?>
                                        <td>
                                            <?php if ($qual->isFeatureEnabledByName('cetagrades')): ?>
                                                <?php echo $qual->getValueAddedComparison( $qual->getUserLatestAssessmentCetaWithAward('summary'), $Student->getUserGrade('weighted_target', array('qualID' => $qual->getID()), false, true), 'ceta' ) ?>
                                            <?php else: ?>
                                            -
                                            <?php endif; ?>
                                        </td>
                                    <?php endif; ?>

                                <?php endif; ?>





                                <?php if ($hasWeightings && \gt_has_capability('block/gradetracker:see_weighting_percentiles')): ?>

                                    <?php if($percentile = $qual->getUserAssessmentWeightingPercentile(null, 'summary')): ?>
                                        <td class="gt_percentile" style="background-color:<?php echo (\block_gradetracker\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;">
                                            <?php echo $percentile->percentile ?>
                                        </td>
                                    <?php else: ?>
                                        <td>-</td>
                                    <?php endif; ?>


                                    <?php if ($Qualification->isFeatureEnabledByName('cetagrades')): ?>

                                        <?php if($percentile = $qual->getUserAssessmentCetaWeightingPercentile(null, 'summary')): ?>
                                            <td class="gt_percentile" style="background-color:<?php echo (\block_gradetracker\QualificationWeighting::getPercentileColour($percentile->percentile)) ?>;">
                                                <?php echo $percentile->percentile ?>
                                            </td>
                                        <?php else: ?>
                                            <td>-</td>
                                        <?php endif; ?>

                                    <?php endif; ?>

                                <?php endif; ?>


                            </tr>
                        <?php endif; ?>

                    <?php endforeach; ?>

                <?php endif; ?>

            </table>
            <br>

        <?php endif; ?>

        <?php if (!isset($print)): ?>
            <?php if (!isset($external) || !$external): ?>
                <p>
                    <input type="button" value="<?php echo $string['view'] ?>" class="gt_load_grid gt_btn" grid="student" access="v" />
                    <?php if (\gt_has_capability('block/gradetracker:edit_student_grids')): ?>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <input id="gt_edit_button" type="button" style="display:<?php echo ($access == 'e') ? 'none' : 'initial' ?>;" value="<?php echo $string['edit'] ?>" class="gt_load_grid gt_btn" grid="student" access="e" />
                        <input id="gt_adv_edit_button" type="button" style="display:<?php echo ($access == 'e') ? 'initial' : 'none' ?>;" value="<?php echo $string['advancededit'] ?>" class="gt_load_grid gt_btn" grid="student" access="ae" />
                    <?php endif; ?>

                    <?php if ($Qualification->getAssessments() && $gridFile != 'assessment_grid'): ?>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a class="gt_btn gt_pink" href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=student&id=<?php echo $Student->id ?>&access=<?php echo $access ?>&qualID=<?php echo $Qualification->getID() ?>&ass=1"><?php echo $string['assessmentgrid'] ?></a>
                    <?php elseif ($Qualification->getAssessments() && $gridFile == 'assessment_grid' && $Qualification->isLevelEnabled('units')): ?>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a class="gt_btn gt_pink" href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=student&id=<?php echo $Student->id ?>&access=<?php echo $access ?>&qualID=<?php echo $Qualification->getID() ?>"><?php echo $string['normalgrid'] ?></a>
                    <?php endif; ?>
                </p>
                <br>

            <?php elseif ($external && $Qualification->getAssessments() && $Qualification->isLevelEnabled('units')): ?>
                <p>
                    <?php if ($gridFile != 'assessment_grid'): ?>
                        <a class="gt_btn gt_pink" href="<?php echo ($extSsn && $extSsn == 'block_elbp') ? $CFG->wwwroot . '/blocks/gradetracker/grid.php?type=student&id='.$Student->id.'&access='.$access.'&qualID='.$Qualification->getID() : $_SERVER['REQUEST_URI'] ?>&ass=1"><?php echo $string['assessmentgrid'] ?></a>
                    <?php else: ?>
                        <a class="gt_btn gt_pink" href="<?php echo ($extSsn && $extSsn == 'block_elbp') ? $CFG->wwwroot . '/blocks/gradetracker/grid.php?type=student&id='.$Student->id.'&access='.$access.'&qualID='.$Qualification->getID() : $_SERVER['REQUEST_URI'] ?>&ass=0"><?php echo $string['grid'] ?></a>
                    <?php endif; ?>
                </p>
            <?php endif; ?>
        <?php endif; ?>


        <?php if (!$assessmentView): ?>
            <div class="gt_grid_key">

                <table>

                    <?php if (!isset($print)): ?>
                        <tr>
                            <th colspan="<?php echo ( count($allPossibleValues) + 1 ) ?>"><?php echo $string['gridkey'] ?></th>
                        </tr>
                    <?php endif; ?>

                    <tr class="imgs">
                        <?php if ($allPossibleValues): ?>
                            <?php foreach($allPossibleValues as $value): ?>
                                <td style="width:<?php echo (100 / (count($allPossibleValues) + 1)) ?>%;">
                                    <img src="<?php echo $value->getImageURL() ?>" alt="<?php echo $value->getShortName() ?>" class="gt_award_icon" />
                                </td>
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <td style="width:<?php echo (100 / (count($allPossibleValues) + 1)) ?>%;">
                            <img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/symbols/default/na.png" alt="<?php echo $string['na'] ?>" class="gt_award_icon" />
                        </td>
                    </tr>
                    <tr class="names">
                        <?php if ($allPossibleValues): ?>
                            <?php foreach($allPossibleValues as $value): ?>
                                <td style="width:<?php echo (100 / (count($allPossibleValues) + 1)) ?>%;"><?php echo $value->getName() ?></td>
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <td style="width:<?php echo (100 / (count($allPossibleValues) + 1)) ?>%;"><?php echo $string['notattempted'] ?></td>
                    </tr>
                </table>

            </div>
            <br>
        <?php endif; ?>

    </div>

    <?php if (!isset($print)): ?>

        <p id="gt_loading" class="gt_hidden"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/ajax-loader.gif" alt="<?php echo $string['loading'] ?>" /></p>

        <?php if (!isset($external) || !$external): ?>
            <?php \gt_display_debug_section() ?>
        <?php endif; ?>

        <?php if (!isset($external) || !$external): ?>
            <?php if ($GT->getSetting('grid_fixed_links') == 1): ?>
                <div id="gt_grid_quick_links">
                    <a href="#" class="gt_load_grid" grid="student" access="v" title="<?php echo $string['redraw'] ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/arrow_refresh.png" class="gt_icon" alt="<?php echo $string['redraw'] ?>" /></a><br>
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/print.php?type=student&id=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?>&courseID=<?php echo $courseID ?>" title="<?php echo $string['printgrid'] ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/printer.png" class="gt_icon" alt="<?php echo $string['printgrid'] ?>" /></a><br>
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/export.php?type=datasheet&grid=student&studentID=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?>&courseID=<?php echo $courseID ?>&sesskey=<?php echo sesskey() ?>" title="<?php echo $string['exportdatasheet'] ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/excel_exports.png" class="gt_icon" alt="<?php echo $string['exportdatasheet'] ?>" /></a><br>
                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/import.php?type=datasheet&grid=student&studentID=<?php echo $Student->id ?>&qualID=<?php echo $Qualification->getID() ?>&courseID=<?php echo $courseID ?>" title="<?php echo $string['importdatasheet'] ?>"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/excel_imports.png" class="gt_icon" alt="<?php echo $string['importdatasheet'] ?>" /></a>
                </div>
            <?php endif; ?>
        <?php endif; ?>

    <?php endif; ?>


    <div id="gt_grid_holder">

        <?php if (isset($print)): ?>
            <?php echo $Qualification->getStudentGridData( array(
                'student' => $Student,
                'assessmentView' => $assessmentView,
                'access' => $access,
                'print' => true,
            ) ) ?>

        <?php elseif (isset($external) && $external == true): ?>
            <?php echo $Qualification->getStudentGridData( array(
                'student' => $Student,
                'assessmentView' => $assessmentView,
                'access' => $access,
                'external' => $external,
                'extSsn' => $extSsn
            ) ) ?>

        <?php endif; ?>

    </div>


    <?php if (!$assessmentView): ?>

        <div id="gt_qual_awards">

            <table>

                <?php if (!isset($print)): ?>
                    <tr>
                        <th colspan='2'><?php echo $string['grades'] ?></th>
                        <th></th>
                        <th id="gt_help_col" title="<?php echo $string['predictedgradesexplained'] ?>"><a href="#" class="gt_toggle" toggle=".gt_toggle_help"><img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/icons/question.png" class="gt_icon" /></a></th>
                    </tr>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('targetgrades') && $User->hasCapability('block/gradetracker:see_target_grade')): ?>

                     <tr>
                        <td><?php echo $string['avggcsescore'] ?></td>
                        <td id="gt_user_gcse_score" colspan="2"><?php echo $Student->getAverageGcseScore() ?></td>
                        <td class="gt_toggle_help"><small><?php echo $string['avggcse:help'] ?></small></td>
                    </tr>

                    <tr>
                        <td><?php echo $string['targetgrade'] ?></td>
                        <td id="gt_user_target_grade_<?php echo $Student->id ?>_<?php echo $Qualification->getID() ?>" colspan="2">
                            <select class='gt_update_user_grade <?php echo ( ($access == 'e' || $access == 'ae') && $User->hasCapability('block/gradetracker:edit_target_grades') ) ? '' : 'gt_hidden' ?> gt_tg_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_edit' sID='<?php echo $Student->id ?>' qID='<?php echo $Qualification->getID() ?>' type='target' txtView='.gt_tg_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_view'>
                                <option value=''></option>
                                <?php if ($targetGradeAwards): ?>
                                    <?php foreach($targetGradeAwards as $award): ?>
                                        <option value='<?php echo $award->getID() ?>' <?php echo ( $Student->getUserGrade('target', array('qualID' => $Qualification->getID()), 'id') == $award->getID() ) ? 'selected' : ''; ?> ><?php echo $award->getName() ?></option>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </select>
                            <span class='gt_tg_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_view <?php echo ( $access == 'v' || !$User->hasCapability('block/gradetracker:edit_target_grades') ) ? '' : 'gt_hidden' ?>'><?php echo $Student->getUserGrade('target', array('qualID' => $Qualification->getID())) ?></span>
                        </td>
                        <td class="gt_toggle_help"><small><?php echo $string['targetgrade:help'] ?></small></td>
                    </tr>

                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('aspirationalgrades') && $User->hasCapability('block/gradetracker:see_aspirational_grade')): ?>
                    <tr>
                        <td><?php echo $string['aspirationalgrade'] ?></td>
                        <td id="gt_user_aspirational_grade" colspan="2">
                                <select class='gt_update_user_grade <?php echo ( ($access == 'e' || $access == 'ae') && $User->hasCapability('block/gradetracker:edit_aspirational_grades') ) ? '' : 'gt_hidden' ?> gt_tg_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_edit' sID='<?php echo $Student->id ?>' qID='<?php echo $Qualification->getID() ?>' type='aspirational' txtView='.gt_asp_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_view'>
                                    <option value=''></option>
                                    <?php if ($targetGradeAwards): ?>
                                        <?php foreach($targetGradeAwards as $award): ?>
                                            <option value='<?php echo $award->getID() ?>' <?php echo ( $Student->getUserGrade('aspirational', array('qualID' => $Qualification->getID()), 'id') == $award->getID() ) ? 'selected' : ''; ?> ><?php echo $award->getName() ?></option>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </select>
                                <span class='gt_asp_Q<?php echo $Qualification->getID() ?>_S<?php echo $Student->id ?>_view <?php echo ( $access == 'v' || !$User->hasCapability('block/gradetracker:edit_aspirational_grades') ) ? '' : 'gt_hidden' ?>'><?php echo $Student->getUserGrade('aspirational', array('qualID' => $Qualification->getID())) ?></span>
                        </td>
                        <td class="gt_toggle_help"><small><?php echo $string['aspirationalgrade:help'] ?></small></td>
                    </tr>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('predictedgrades') && !$Qualification->getUserAward('final') && $User->hasCapability('block/gradetracker:see_predicted_grades')): ?>
                    <tr>
                        <td><?php echo $string['predictedgrade'] ?></td>
                        <td id="gt_user_avg_award" colspan="<?php echo ($showUCAS == '1') ? '1' : '2' ?>"><?php echo $Qualification->getUserAwardName('average') ?></td>
                        <?php if ($showUCAS): ?>
                            <td><small><?php echo $Qualification->getUserAwardUCAS('average') ?><br><strong><?php echo $string['ucaspoints'] ?></strong></small></td>
                        <?php endif; ?>
                        <td class="gt_toggle_help"><small><?php echo sprintf($string['predictedgrade:desc'], $GT->getSetting('pred_grade_min_units')) ?></small></td>
                    </tr>
                <?php endif; ?>

                <?php if ($Qualification->isFeatureEnabledByName('predictedminmaxgrades') && $User->hasCapability('block/gradetracker:see_predicted_grades')): ?>
                    <tr>
                        <td><?php echo $string['predictedmingrade'] ?></td>
                        <td id="gt_user_min_award" colspan="<?php echo ($showUCAS == '1') ? '1' : '2' ?>"><?php echo $Qualification->getUserAwardName('min') ?></td>
                        <?php if ($showUCAS): ?>
                            <td><small><?php echo $Qualification->getUserAwardUCAS('min') ?><br><strong><?php echo $string['ucaspoints'] ?></strong></small></td>
                        <?php endif; ?>
                        <td class="gt_toggle_help"><small><?php echo sprintf($string['predictedmingrade:desc'], $GT->getSetting('pred_grade_min_units')) ?></small></td>
                    </tr>
                    <tr>
                        <td><?php echo $string['predictedmaxgrade'] ?></td>
                        <td id="gt_user_max_award" colspan="<?php echo ($showUCAS == '1') ? '1' : '2' ?>"><?php echo $Qualification->getUserAwardName('max') ?></td>
                        <?php if ($showUCAS): ?>
                            <td><small><?php echo $Qualification->getUserAwardUCAS('max') ?><br><strong><?php echo $string['ucaspoints'] ?></strong></small></td>
                        <?php endif; ?>
                        <td class="gt_toggle_help"><small><?php echo sprintf($string['predictedmaxgrade:desc'], $GT->getSetting('pred_grade_min_units')) ?></small></td>
                    </tr>
                <?php endif; ?>

                <?php if ($Qualification->getUserAward('final')): ?>
                    <tr id="gt_user_final_award_row">
                        <td><?php echo $string['predictedfinalgrade'] ?></td>
                        <td id="gt_user_final_award" colspan="<?php echo ($showUCAS == '1') ? '1' : '2' ?>"><?php echo $Qualification->getUserAwardName('final') ?></td>
                        <?php if ($showUCAS): ?>
                            <td><small><?php echo $Qualification->getUserAwardUCAS('final') ?><br><strong><?php echo $string['ucaspoints'] ?></strong></small></td>
                        <?php endif; ?>
                        <td class="gt_toggle_help"><small><?php echo $string['predictedfinalgrade:desc'] ?></small></td>
                    </tr>
                <?php endif; ?>

            </table>
        </div>

    <?php endif; ?>

    <?php if (isset($print) && !$assessmentView): ?>

        <p style="text-align:center;"><a href="#" class="gt_toggle" toggle="#gt_student_grid_comments"><?php echo $string['showhidecomments'] ?></a></p>
        <table id="gt_student_grid_comments" class="gt_student_assessment_grid_comments" style='display:none;' cellspacing='0'>
            <tr><th colspan='2'><?php echo $string['comments'] ?></th></tr>
            <?php if ($Qualification->getUnits()): ?>
                <?php foreach($Qualification->getUnits() as $unit): ?>
                    <tr>
                        <th><?php echo $unit->getDisplayName() ?></th>
                        <th><?php echo $string['comment'] ?></th>
                    </tr>
                    <?php if ($unit->getCriteria()): ?>
                        <?php foreach($unit->getCriteria() as $criterion): ?>
                            <tr>
                                <td><b><?php echo $criterion->getName() ?></b></td>
                                <td><small><?php echo $criterion->getUserComments() ?></small></td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                <?php endforeach; ?>
            <?php endif; ?>
        </table>

    <?php endif; ?>

</div>


<?php if (isset($external) && $external == true): ?>

    <?php echo $GT->loadJavascript( true ) ?>
    <?php echo $GT->loadCSS (true ) ?>

<?php endif; ?>
