<?php if(!defined('BCGT')) exit; ?>



<table id="gt_student_grid" class="gt_student_grid" style="width:95%;">

    <?php $cnt = 2; ?>
    <thead>
      <tr>
          <th class="gt_grid_unit_name"><?php echo $string['unit'] ?> <?php echo ($Qualification->getDefaultCredits() > 0) ? '('.$string['totalcredits'] . ': '.$Qualification->countUnitCredits().'/'.$Qualification->getDefaultCredits().')' : '' ?></th>
          <th class="gt_grid_unit_award"><?php echo $string['award'] ?></th>
          <?php if ($Qualification->isFeatureEnabledByName('percentagecomp')): ?>
              <th class="gt_grid_progress"><?php echo $string['progress'] ?></th>
              <?php $cnt++ ?>
          <?php endif; ?>

          <?php foreach($Qualification->getHeaderCriteriaNames() as $crit): ?>
              <th cname="<?php echo $crit['name'] ?>"><?php echo $crit['name'] ?></th>
              <?php $cnt++ ?>
              <?php if ($crit['sub']): ?>
                  <?php foreach($crit['sub'] as $sub): ?>
                      <th><?php echo $sub ?></th>
                      <?php $cnt++ ?>
                  <?php endforeach; ?>
              <?php endif; ?>
          <?php endforeach; ?>

          <?php if ($Qualification->getStructure() && $Qualification->getStructure()->getSetting('iv_column') == 1): ?>
              <?php $cnt++ ?>
              <th title='<?php echo $string['iv:desc'] ?>'><?php echo $string['iv'] ?></th>
          <?php endif; ?>

          <?php if (!isset($print) || !$print): ?>
              <th class='gt_grid_end'></th>
          <?php endif; ?>

      </tr>
    </thead>

    <tbody>
      <?php if ($Qualification->getUnits()): ?>

          <?php foreach($Qualification->getUnits() as $unit): ?>

              <?php if($Student->isOnQualUnit($Qualification->getID(), $unit->getID(), "STUDENT")): ?>

                  <tr>

                      <td class="gt_grid_unit_name">
                          <?php if (\gt_has_capability('block/gradetracker:view_unit_grids') && (!isset($print) || !$print)): ?>
                              <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=unit&id=<?php echo $unit->getID() ?>&qualID=<?php echo $Qualification->getID() ?>&access=<?php echo $params['access'] ?>" target="_blank"><?php echo $unit->getShortenedDisplayName() ?></a>
                          <?php else: ?>
                              <?php echo $unit->getShortenedDisplayName() ?>
                          <?php endif; ?>

                          <?php if (!isset($print) || !$print): ?>

                              <br><a href="#" class="gt_unit_info" uID="<?php echo $unit->getID() ?>" uName="<?php echo \gt_html($unit->getDisplayName()) ?>"><img src="<?php echo gt_image_url('i/info') ?>" alt="<?php echo $string['info'] ?>" /></a>

                              <?php if ( \gt_has_capability('block/gradetracker:configure_units') && !$external): ?>
                                  &nbsp;&nbsp;
                                  <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/config.php?view=units&section=edit&id=<?php echo $unit->getID() ?>" target="_blank"><img src="<?php echo gt_image_url('i/edit') ?>" alt="<?php echo $string['edit'] ?>" /></a>
                              <?php endif; ?>

                              <div id="pUUI_<?php echo $unit->getID() ?>" class="gt_popup gt_hidden"></div>

                          <?php endif; ?>

                          <?php if ($unit->getCredits() > 0): ?>
                              <br><small>(<?php echo $unit->getCredits() ?> <?php echo $string['credits'] ?>)</small>
                          <?php endif; ?>

                      </td>

                      <td class="gt_grid_unit_award" sID="<?php echo $Student->id ?>" qID="<?php echo $Qualification->getID() ?>" uID="<?php echo $unit->getID() ?>"><?php echo $unit->getAwardCell( $params['access'] ) ?></td>

                      <!-- Progress Bar -->
                      <?php if ($Qualification->isFeatureEnabledByName('percentagecomp')): ?>
                          <td class="gt_grid_progress">
                              <?php if ($unit->unitCal() === $string['na']): ?>
                                  <?php echo $string['na']; ?>
                              <?php else: ?>
                                  <div class="gt_meter">
                                      <span class='progress_bar_S<?php echo $Student->id ?>Q<?php echo $Qualification->getID() ?>U<?php echo $unit->getID() ?>' style="width: <?php echo $unit->unitCal() ?>%"></span>
                                  </div>
                                  <small class='progress_percent_S<?php echo $Student->id ?>Q<?php echo $Qualification->getID() ?>U<?php echo $unit->getID() ?>'><?php echo $unit->unitCal() ?>%</small>
                              <?php endif; ?>
                          </td>
                      <?php endif; ?>


                      <?php foreach($Qualification->getHeaderCriteriaNames() as $crit): ?>

                          <?php if ( ($criterion = $unit->getCriterionByName($crit['name'])) !== false  ): ?>
                              <td id="CRITERION_Q_<?php echo $Qualification->getID() ?>U_<?php echo $unit->getID() ?>C_<?php echo $criterion->getID() ?>S_<?php echo $Student->id ?>" class="gt_grid_cell gt_grid_cell_<?php echo $params['access'] ?> <?php echo ($criterion->hasUserComments()) ? 'gt_has_comments' : '' ?>" sID="<?php echo $Student->id ?>" qID="<?php echo $Qualification->getID() ?>" uID="<?php echo $unit->getID() ?>" cID="<?php echo $criterion->getID() ?>" cName="<?php echo \gt_html($criterion->getName()) ?>" access="<?php echo $params['access'] ?>">
                                  <?php echo $criterion->getCell( $params['access'] ) ?>
                                  <div id='pU_<?php echo $Student->id ?>_<?php echo $Qualification->getID() ?>_<?php echo $unit->getID() ?>_<?php echo $criterion->getID() ?>' class='gt_popup' title='<?php echo \gt_html($criterion->getName()) ?>'></div>
                              </td>
                          <?php else: ?>
                              <td class="gt_cell_blank"></td>
                          <?php endif; ?>

                          <?php if ($crit['sub']): ?>
                              <?php foreach($crit['sub'] as $sub): ?>
                                  <?php if ( ($criterion = $unit->getCriterionByName($sub)) !== false  ): ?>
                                      <td id="CRITERION_Q_<?php echo $Qualification->getID() ?>U_<?php echo $unit->getID() ?>C_<?php echo $criterion->getID() ?>S_<?php echo $Student->id ?>" class="gt_grid_cell gt_grid_cell_<?php echo $params['access'] ?> <?php echo ($criterion->hasUserComments()) ? 'gt_has_comments' : '' ?>" sID="<?php echo $Student->id ?>" qID="<?php echo $Qualification->getID() ?>" uID="<?php echo $unit->getID() ?>" cID="<?php echo $criterion->getID() ?>"  cName="<?php echo \gt_html($criterion->getName()) ?>" access="<?php echo $params['access'] ?>">
                                          <?php echo $criterion->getCell( $params['access'] ) ?>
                                          <div id='pU_<?php echo $Student->id ?>_<?php echo $Qualification->getID() ?>_<?php echo $unit->getID() ?>_<?php echo $criterion->getID() ?>' class='gt_popup' title='<?php echo \gt_html($criterion->getName()) ?>'></div>
                                      </td>
                                  <?php else: ?>
                                      <td class="gt_cell_blank"></td>
                                  <?php endif; ?>
                              <?php endforeach; ?>
                          <?php endif; ?>

                      <?php endforeach; ?>

                      <?php if ($Qualification->getStructure() && $Qualification->getStructure()->getSetting('iv_column') == 1): ?>
                          <?php echo $unit->getIVCell( $params['access'] ) ?>
                      <?php endif; ?>

                      <?php if (!isset($print) || !$print): ?>
                          <!-- This is a nasty hack -->
                          <td class='gt_grid_end'>
                              <img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/empty.png">
                          </td>
                      <?php endif; ?>

                  </tr>

              <?php endif; ?>

          <?php endforeach; ?>

      <?php else: ?>

          <tr>
              <td colspan="<?php echo $cnt ?>"><?php echo $string['nodata'] ?></td>
          </tr>

      <?php endif; ?>
    </tbody>

</table>