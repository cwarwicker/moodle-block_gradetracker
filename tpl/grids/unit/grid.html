<?php if(!defined('BCGT')) exit; ?>
<table id="gt_unit_grid" class="gt_unit_grid <?php echo ($view == 'activities') ? 'gt_unit_activity_grid' : ''; ?>" style="width:95%;">

    <?php if ($view == 'activities'): ?>

        <tr class='gt_unit_grid_activity_header'>

            <?php if ($studentCols): ?>
                <?php foreach($studentCols as $col): ?>
                    <th class="gt_grid_user_<?php echo $col ?> gt_grid_freeze_col" rowspan='2'><?php echo ($col != 'pic') ? get_string($col) : '' ?></th>
                <?php endforeach; ?>
            <?php endif; ?>

            <th class="gt_grid_qual_award gt_grid_freeze_col" rowspan='2'><?php echo $string['qualaward'] ?></th>
            <th class="gt_grid_unit_award gt_grid_freeze_col" rowspan='2'><?php echo $string['unitaward'] ?></th>

            <?php if ($settings['percentage']): ?>
                <th class="gt_grid_progress gt_grid_freeze_col" rowspan='2'><?php echo $string['progress'] ?></th>
            <?php endif; ?>


            <?php if ($activities): ?>
                <?php foreach($activities as $activity): ?>
                    <th colspan='<?php echo count($activity->criteria) ?>'>
                        <img src='<?php echo $activity->getModIcon() ?>' alt='<?php echo $activity->getModName() ?>' /> <?php echo $activity->getRecordName() ?>
                        <br>
                        <small><?php echo $activity->getRecordDueDate('D jS M Y, H:i') ?></small>
                    </th>
                <?php endforeach; ?>
            <?php endif; ?>


            <?php if ( ($nonLinked = $Unit->getCriteriaNotLinkedToActivities()) ): ?>
                <th colspan='<?php echo count($nonLinked) ?>'><?php echo $string['other'] ?></th>
            <?php endif; ?>


            <?php if ($settings['iv']): ?>
                <th title='<?php echo $string['iv:desc'] ?>'></th>
            <?php endif; ?>


            <?php if (!isset($print) || !$print): ?>
                <th class='gt_grid_end'></th>
            <?php endif; ?>

        </tr>

    <?php endif; ?>

        <tr>

            <?php if ($view != 'activities' && $studentCols): ?>
                <?php foreach($studentCols as $col): ?>
                    <th class="gt_grid_user_<?php echo $col ?> gt_grid_freeze_col"><?php echo ($col != 'pic') ? get_string($col) : '' ?></th>
                <?php endforeach; ?>
            <?php endif; ?>

            <?php if ($view != 'activities'): ?>

                <th class="gt_grid_qual_award gt_grid_freeze_col"><?php echo $string['qualaward'] ?></th>
                <th class="gt_grid_unit_award gt_grid_freeze_col"><?php echo $string['unitaward'] ?></th>

                <?php if ($settings['percentage']): ?>
                    <th class="gt_grid_progress gt_grid_freeze_col"><?php echo $string['progress'] ?></th>
                <?php endif; ?>

            <?php endif; ?>

            <?php foreach($criteria as $crit): ?>
                <th><?php echo $crit ?></th>
            <?php endforeach; ?>

            <?php if ($settings['iv']): ?>
                <th title='<?php echo $string['iv:desc'] ?>'><?php echo $string['iv'] ?></th>
            <?php endif; ?>

            <?php if (!isset($print) || !$print): ?>
                <th class='gt_grid_end'></th>
            <?php endif; ?>

        </tr>



    <?php if ($students): ?>

        <?php foreach($students as $student): ?>

            <?php $Unit->loadStudent($student) ?>

                <tr>

                    <?php if ($studentCols): ?>

                        <?php foreach($studentCols as $col): ?>

                            <td>
                                <?php if( \gt_has_capability('block/gradetracker:view_student_grids') && !isset($print) ): ?>
                                    <a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=student&id=<?php echo $student->id ?>&qualID=<?php echo $Qualification->getID() ?>&access=<?php echo $params['access'] ?>" target="_blank"><?php echo $student->getProp($col) ?></a>
                                <?php else: ?>
                                    <?php echo $student->getProp($col) ?>
                                <?php endif; ?>
                            </td>

                        <?php endforeach; ?>

                    <?php endif; ?>


                    <td class="gt_grid_qual_award qual_award_<?php echo $student->id ?>_<?php echo $Qualification->getID() ?>" sID="<?php echo $student->id ?>" qID="<?php echo $Qualification->getID() ?>">
                        <?php if ($qualAward = $student->getQualAward($Qualification->getID())): ?>
                            <?php echo $string[$qualAward[0]] ?><br>
                            <?php echo $qualAward[1]->getName() ?>
                        <?php else: ?>
                            <?php echo $string['na'] ?>
                        <?php endif; ?>
                    </td>

                    <td class="gt_grid_unit_award" sID="<?php echo $student->id ?>" qID="<?php echo $Qualification->getID() ?>" uID="<?php echo $Unit->getID() ?>"><?php echo $Unit->getAwardCell( $params['access'] ) ?></td>

                    <!-- Progress Bar -->
                    <?php if ($settings['percentage']): ?>
                        <td class="gt_grid_progress" sID="<?php echo $student->id ?>" qID="<?php echo $Qualification->getID() ?>">
                            <?php if ($Unit->unitCal() === $string['na']): ?>
                                <?php echo $string['na']; ?>
                            <?php else: ?>
                                <div class="gt_meter">
                                    <span class='progress_bar_S<?php echo $student->id ?>Q<?php echo $Qualification->getID() ?>U<?php echo $Unit->getID() ?>' style="width: <?php echo $Unit->unitCal() ?>%"></span>
                                </div>
                            <small class='progress_percent_S<?php echo $student->id ?>Q<?php echo $Qualification->getID() ?>U<?php echo $Unit->getID() ?>'><?php echo $Unit->unitCal() ?>%</small>
                            <?php endif; ?>
                        </td>
                    <?php endif; ?>




                    <?php foreach($criteria as $crit): ?>

                        <?php if ( ($criterion = $Unit->getCriterionByName($crit)) !== false  ): ?>
                            <td id="CRITERION_Q_<?php echo $Qualification->getID() ?>U_<?php echo $Unit->getID() ?>C_<?php echo $criterion->getID() ?>S_<?php echo $student->id ?>" class="CRITERION_Q_<?php echo $Qualification->getID() ?>U_<?php echo $Unit->getID() ?>C_<?php echo $criterion->getID() ?>S_<?php echo $student->id ?> gt_grid_cell gt_grid_cell_<?php echo $params['access'] ?> <?php echo ($criterion->hasUserComments()) ? 'gt_has_comments' : '' ?>" sID="<?php echo $student->id ?>" qID="<?php echo $Qualification->getID() ?>" uID="<?php echo $Unit->getID() ?>" cID="<?php echo $criterion->getID() ?>" cName="<?php echo \gt_html($criterion->getName()) ?>" access="<?php echo $params['access'] ?>">
                                <?php echo $criterion->getCell( $params['access'] ) ?>
                                <div id='pU_<?php echo $student->id ?>_<?php echo $Qualification->getID() ?>_<?php echo $Unit->getID() ?>_<?php echo $criterion->getID() ?>' class='gt_popup' title='<?php echo \gt_html($criterion->getName()) ?>'></div>
                                <?php if ($view == 'activities' && $params['access'] == 'ae'): ?>
                                    <div class='gt_unit_activity_width_fix' style='width:135px;'></div>
                                <?php endif; ?>
                            </td>
                        <?php else: ?>
                            <td class="gt_cell_blank"></td>
                        <?php endif; ?>

                    <?php endforeach; ?>




                    <?php if ($settings['iv']): ?>
                        <?php echo $Unit->getIVCell( $params['access'] ) ?>
                    <?php endif; ?>

                    <?php if (!isset($print) || !$print): ?>
                        <!-- This is a nasty hack -->
                        <td class='gt_grid_end'>
                            <img src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/empty.png">
                        </td>
                    <?php endif; ?>

                </tr>

        <?php endforeach; ?>

    <?php else: ?>

        <tr>
            <td colspan="<?php echo $settings['cnt'] ?>"><?php echo $string['nodata'] ?></td>
        </tr>

    <?php endif; ?>


</table>