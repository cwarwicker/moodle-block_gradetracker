<!--Student Table-->
<tr id='gt_table_row_<?php echo $qualification->getID(); ?>'>
    <td colspan='5' class='gt_hide_borders'>
        <div id="student_filter_<?php echo $qualification->getID() ?>">
        <h5><?php echo $string['studenresultsfilter']; ?>:</h5>
            <select class="gt_filter_qualification_report" qualID="<?php echo $qualification->getID() ?>">
                <option value="all"><?php echo $string['studenresultsfilter:all']; ?></option>
                <option value="allmarked"><?php echo $string['studenresultsfilter:allmarked']; ?></option>
                <option value="someoutstanding"><?php echo $string['studenresultsfilter:someoutstanding']; ?></option>
                <option value="alloutstanding"><?php echo $string['studenresultsfilter:alloutstanding']; ?></option>
            </select>
        </div>
        <div id='students_view_buttons'>
            <br>

            <?php if ($qualification->isFeatureEnabledByName('targetgrades')): ?>
                <?php if ($User->hasCapability('block/gradetracker:edit_target_grades')): ?>
                    <a href='#' type="target" qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_blue gt_small_text gt_toggle_edit_grades'><?php echo $string['edittargetgrades'] ?></a>
                    &nbsp;&nbsp;
                    <a href='#' type="target" qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_green gt_small_text gt_calculate_grades'><?php echo $string['calculatetargetgrades'] ?></a>
                    &nbsp;&nbsp;
                <?php endif; ?>
            <?php endif; ?>

            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            <?php if ($qualification->isFeatureEnabledByName('cetagrades')): ?>
                <?php if ($User->hasCapability('block/gradetracker:edit_ceta_grades')): ?>
                    <a href='#' type="ceta" qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_blue gt_small_text gt_toggle_edit_grades'><?php echo $string['editcetagrades'] ?></a>
                    &nbsp;&nbsp;
                <?php endif; ?>
            <?php endif; ?>

            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            <?php if ($qualification->isFeatureEnabledByName('aspirationalgrades')): ?>
                <?php if ($User->hasCapability('block/gradetracker:edit_aspirational_grades')): ?>
                    <a href='#' type="aspirational" qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_blue gt_small_text gt_toggle_edit_grades'><?php echo $string['editaspgrades'] ?></a>
                    &nbsp;&nbsp;
                    <a href='#' type="aspirational" qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_green gt_small_text gt_calculate_grades'><?php echo $string['calculateaspirationalgrades'] ?></a>
                    &nbsp;&nbsp;
                <?php endif; ?>
            <?php endif; ?>



            <br><br>

            <?php if ($qualification->isFeatureEnabledByName('predictedgrades') || $qualification->isFeatureEnabledByName('predictedminmaxgrades')): ?>
                &nbsp;&nbsp;
                    <a href='#' qualID="<?php echo $qualification->getID() ?>" class='gt_btn gt_yellow gt_small_text gt_refresh_predicted_grades'><?php echo $string['refreshpredictedgrades'] ?></a>
                &nbsp;&nbsp;
            <?php endif; ?>

            <br><br>
            <img id="loading_<?php echo $qualification->getID() ?>" style="display:none;" src="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/pix/ajax-loader.gif" />
        </div>

    <ul class="gt_tabrow">
        <li id="students_<?php echo $qualification->getID() ?>" class="selected"><a href="#" class="gt_change_report_tab" qualID="<?php echo $qualification->getID() ?>" tab="students"><?php echo $string['students']; ?></a></li>
        <?php if($qualification->isLevelEnabled("Units")): ?>
            <li id="units_<?php echo $qualification->getID() ?>" class=""><a href="#" class="gt_change_report_tab" qualID="<?php echo $qualification->getID() ?>" tab="units"><?php echo $string['units']; ?></a></li>
        <?php endif; ?>
    </ul>

       <!--student table-->
        <div id="student_table_view_<?php echo $qualification->getID() ?>">

            <table id="qualification_report_table_<?php echo $qualification->getID() ?>" style="width:100%">
            <tr>
                <th><?php echo get_string('name', 'block_gradetracker'); ?></th>

                <?php if($qualification->isFeatureEnabledByName("targetgrades")): ?>
                    <th><?php echo $string['targetgrade:short']; ?></th>
                <?php endif; ?>

                <?php if($qualification->isFeatureEnabledByName("weightedtargetgrades")): ?>
                    <th><?php echo $string['weightedtargetgrade:short']; ?></th>
                <?php endif; ?>

                <?php if($qualification->isFeatureEnabledByName("aspirationalgrades")): ?>
                    <th><?php echo $string['aspirationalgrade:short']; ?></th>
                <?php endif; ?>

                <?php if($qualification->isFeatureEnabledByName("cetagrades")): ?>
                    <th><?php echo $string['cetagrade:short']; ?></th>
                <?php endif; ?>

                <th><?php echo $string['qualaward']; ?></th>

                <?php if($qualification->isFeatureEnabledByName("targetgrades") || $qualification->isFeatureEnabledByName("aspirationalgrades")): ?>
                    <th><?php echo $string['valueadded:acronym']; ?></th>
                <?php endif; ?>

                <?php if($qualification->isLevelEnabled("Units")): ?>
                    <th><?php echo $string['numberofcreditsawarded']; ?></th>
                    <th><?php echo $string['numberofunitsawarded']; ?></th>
                <?php endif; ?>

                <!-- unit awards -->
                <?php if($qualification->isLevelEnabled("Units") && $awards): ?>
                    <?php foreach($awards as $a): ?>
                        <th class='gt_generated_unit_header'><?php echo $a ?></th>
                    <?php endforeach; ?>
                <?php endif; ?>

                <!--full view-->
                <?php if($view == 'view-criteria-full'): ?>
                    <?php foreach($names as $name): ?>
                        <th class="gt_generated_header"><?php echo $name['name']  ?></th>
                    <?php endforeach; ?>
                <?php endif; ?>

                <!--short view-->
                <?php if($view == 'view-criteria-short'): ?>
                    <?php foreach($uniquename as $u): ?>
                        <th class="gt_generated_header"><?php echo $u ?></th>
                    <?php endforeach; ?>
                <?php endif; ?>

                <th><?php echo $string['grid']; ?></th>
            </tr>

            <?php if ($studentsReport): ?>
                <?php foreach($studentsReport as $row): ?>

                <tr class="reporting_table_row_<?php echo $qualification->getID() ?>" unitsawarded="<?php echo (int)$row->unitsawardedcount; ?>" totalunits="<?php echo (int)$row->unitscount; ?>">
                        <td><?php echo $row->firstname ?> <?php echo $row->lastname ?> (<?php echo $row->username ?>)</td>
                        <?php if($qualification->isFeatureEnabledByName("targetgrades")): ?>
                            <td>
                                <span id='stud_target_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_target_grade_view_<?php echo $qualification->getID() ?>'><?php echo $row->targetgrade ?></span>
                                <?php if ($User->hasCapability('block/gradetracker:edit_target_grades')): ?>
                                  <span id='stud_target_grade_edit_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_target_grade_edit_<?php echo $qualification->getID() ?>' style="display:none;">
                                      <select class="gt_update_user_grade" type="target" qID="<?php echo $qualification->getID() ?>" sID="<?php echo $row->id ?>" txtView="#stud_target_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>">
                                          <option value=''></option>
                                          <?php if ($qualification->getBuild() && $qualification->getBuild()->getAwards()): ?>
                                              <?php foreach($qualification->getBuild()->getAwards() as $award): ?>
                                                  <option value="<?php echo $award->getID() ?>" <?php echo ($row->targetgradeid == $award->getID()) ? 'selected' : '' ?> ><?php echo $award->getName() ?></option>
                                              <?php endforeach; ?>
                                          <?php endif; ?>
                                      </select>
                                  </span>
                                <?php endif; ?>
                            </td>
                        <?php endif; ?>

                        <?php if($qualification->isFeatureEnabledByName("weightedtargetgrades")): ?>
                            <td>
                                <span id='stud_weighted_target_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>'><?php echo $row->weightedtargetgrade ?></span>
                            </td>
                        <?php endif; ?>

                        <?php if($qualification->isFeatureEnabledByName("aspirationalgrades")): ?>
                            <td>
                                <span id='stud_aspirational_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_aspirational_grade_view_<?php echo $qualification->getID() ?>'><?php echo $row->aspirationalgrade ?></span>
                                <?php if ($User->hasCapability('block/gradetracker:edit_aspirational_grades')): ?>
                                    <span id='stud_aspirational_grade_edit_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_aspirational_grade_edit_<?php echo $qualification->getID() ?>' style="display:none;">
                                        <select class="gt_update_user_grade" type="aspirational" qID="<?php echo $qualification->getID() ?>" sID="<?php echo $row->id ?>" txtView="#stud_aspirational_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>">
                                            <option value=''></option>
                                            <?php if ($qualification->getBuild() && $qualification->getBuild()->getAwards()): ?>
                                                <?php foreach($qualification->getBuild()->getAwards() as $award): ?>
                                                    <option value="<?php echo $award->getID() ?>" <?php echo ($row->aspirationalgradeid == $award->getID()) ? 'selected' : '' ?> ><?php echo $award->getName() ?></option>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                        </select>
                                    </span>
                                <?php endif; ?>
                            </td>
                        <?php endif; ?>

                        <?php if($qualification->isFeatureEnabledByName("cetagrades")): ?>
                            <td>
                                <span id='stud_ceta_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_ceta_grade_view_<?php echo $qualification->getID() ?>'><?php echo $row->cetagrade ?></span>
                                <?php if ($User->hasCapability('block/gradetracker:edit_ceta_grades')): ?>
                                    <span id='stud_ceta_grade_edit_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>' class='stud_ceta_grade_edit_<?php echo $qualification->getID() ?>' style="display:none;">
                                        <select class="gt_update_user_grade" type="ceta" qID="<?php echo $qualification->getID() ?>" sID="<?php echo $row->id ?>" txtView="#stud_ceta_grade_view_<?php echo $qualification->getID() ?>_<?php echo $row->id ?>">
                                            <option value=''></option>
                                            <?php if ($qualification->getBuild() && $qualification->getBuild()->getAwards()): ?>
                                                <?php foreach($qualification->getBuild()->getAwards() as $award): ?>
                                                    <option value="<?php echo $award->getID() ?>" <?php echo ($row->cetagradeid == $award->getID()) ? 'selected' : '' ?> ><?php echo $award->getName() ?></option>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                        </select>
                                    </span>
                                <?php endif; ?>
                            </td>
                        <?php endif; ?>

                        <td id="gt_qualAward_Q<?php echo $qualification->getID() ?>_S<?php echo $row->id ?>">
                            <?php if (!is_null($row->qualaward)): ?>
                                <?php echo $row->qualaward ?> (<?php echo ucfirst($row->qualawardtype) ?>)
                                <?php if ($row->qualawarducas > 0): ?>
                                    <br><small><?php echo $row->qualawarducas ?> <?php echo $string['ucaspoints'] ?></small>
                                <?php endif; ?>
                            <?php endif; ?>
                        </td>

                        <?php if($qualification->isFeatureEnabledByName("targetgrades") || $qualification->isFeatureEnabledByName("aspirationalgrades")): ?>
                            <td>
                                <?php if (!is_null($row->qualawardrank)): ?>

                                    <?php if (!is_null($row->aspirationalgraderank)): ?>
                                        <div class="gt_value_added_score <?php echo \gt_get_value_added_class($row->qualawardrank, $row->aspirationalgraderank) ?>"><?php echo ($row->qualawardrank - $row->aspirationalgraderank) ?></div>
                                    <?php elseif (!is_null($row->targetgraderank)): ?>
                                        <div class="gt_value_added_score <?php echo \gt_get_value_added_class($row->qualawardrank, $row->targetgraderank) ?>"><?php echo ($row->qualawardrank - $row->targetgraderank) ?></div>
                                    <?php endif; ?>

                                <?php else: ?>
                                    -
                                <?php endif; ?>
                            </td>
                        <?php endif; ?>

                        <?php if($qualification->isLevelEnabled("Units")): ?>
                            <td><?php echo (int)$row->creditsawardedcount; ?> / <?php echo (int)$row->creditscount ?></td>
                            <td><?php echo (int)$row->unitsawardedcount; ?> / <?php echo (int)$row->unitscount ?></td>
                            <?php if ($awards): ?>
                                <?php foreach($awards as $award): ?>
                                    <?php $fieldName = 'unitawardcnt_'.\gt_make_db_field_safe($award, $usedFieldNames['unit']); ?>
                                    <td><?php echo (int)$row->$fieldName ?></td>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        <?php endif; ?>

                        <?php if($view == 'view-criteria-short'): ?>
                            <?php foreach($uniquename as $u): ?>
                                <?php $fieldName = 'critawardcnt_'.\gt_make_db_field_safe($u, $usedFieldNames['crit']); ?>
                                <?php $fieldNameTtl = 'critcnt_'.\gt_make_db_field_safe($u, $usedFieldNames['crit']); ?>
                                <td><?php echo (int)$row->$fieldName ?> / <?php echo (int)$row->$fieldNameTtl ?></td>
                            <?php endforeach; ?>
                        <?php elseif($view == 'view-criteria-full'): ?>
                            <?php foreach($names as $name): ?>
                                <?php $fieldName = 'critawardcnt_'.\gt_make_db_field_safe($name['name'], $usedFieldNames['crit']); ?>
                                <?php $fieldNameTtl = 'critcnt_'.\gt_make_db_field_safe($name['name'], $usedFieldNames['crit']); ?>
                                <td><?php echo (int)$row->$fieldName ?> / <?php echo (int)$row->$fieldNameTtl ?></td>
                            <?php endforeach; ?>
                        <?php endif; ?>

                        <td><a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=student&id=<?php echo $row->id ?>&qualID=<?php echo$qualification->getID() ?>" target="_blank"><?php echo $string['viewgrid']; ?></a></td>

                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>

            </table>

            <?php if (!$studentsReport): ?>
                <p class='gt_c'><?php echo $string['qualnostuds'] ?></p>
            <?php endif; ?>

        </div>

        <!--unit table-->
        <?php if($qualification->isLevelEnabled("Units")): ?>
            <div id="unit_table_view_<?php echo $qualification->getID() ?>" style="display:none;margin:auto;">
                <table id="unit_report_table_<?php echo $qualification->getID() ?>" class="tablesorter">
                    <!--headers-->
                    <thead>
                    <tr>
                        <th><?php echo $string['unitname']; ?></th>
                        <th><?php echo $string['withunitawarddoingunit']; ?></th>
                        <?php foreach($awards as $a): ?>
                            <th class='gt_generated_unit_header'><?php echo $a ?></th>
                        <?php endforeach; ?>
                        <th><?php echo $string['grid']; ?></th>
                    </tr>
                    </thead>
                    <!--table rows-->
                    <tbody>
                    <?php if ($unitsReport): ?>
                        <?php foreach($unitsReport as $row): ?>
                        <tr>
                            <td><?php echo \GT\Unit::name($row->id); ?></td>
                            <td><?php echo (int)$row->studsawardedunit ?> / <?php echo (int)$row->studsonunit ?></td>
                            <?php foreach($awards as $award): ?>
                                <?php $fieldName = 'unitawardcnt_'.\gt_make_db_field_safe($award, $usedFieldNames['unit']); ?>
                                <td><?php echo (int)$row->$fieldName ?></td>
                            <?php endforeach; ?>
                            <td><a href="<?php echo $CFG->wwwroot ?>/blocks/gradetracker/grid.php?type=unit&id=<?php echo$row->id ?>&qualID=<?php echo$qualification->getID() ?>" target="_blank"><?php echo $string['viewgrid']; ?></a></td>
                        </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                    </tbody>
                </table>
                <br />
            </div>
        <?php endif; ?>

    </td>
</tr>